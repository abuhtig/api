!function(e){var t={};function a(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(i,s,function(t){return e[t]}.bind(null,s));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=33)}([function(e,t){e.exports=require("dayjs")},function(e,t,a){"use strict";a.d(t,"a",(function(){return r})),a.d(t,"b",(function(){return d}));var i=a(6),s=a(3),o=a(9),n=a.n(o);const d=e=>n.a.verify(e.split(" ")[1],s.a.JWT_SERCET),r=async(e,t)=>{const a=await Object(i.a)(e);return null!=a&&a.toLowerCase()==t.toLowerCase()}},function(e,t,a){"use strict";var i=a(10),s=a.n(i),o=a(3);s.a.set("useCreateIndex",!0),s.a.connect(o.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),s.a.connection.on("connected",()=>{console.log("Mongoose connection open to "+o.a.DB_URL)}),s.a.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),s.a.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")}),t.a=s.a},function(e,t,a){"use strict";(function(e){var i=a(12),s=a.n(i);const o=s.a.join(s.a.resolve(e),"../../public");t.a={DB_URL:"mongodb://test:password@120.48.21.232:27017/testdb",REDIS:{host:"120.48.21.232",port:6379,password:"123456"},JWT_SERCET:"F&l8mWkDt$9a1lQBuaej9oJ2T35@u7ur69szx6smKJINzMbUYjHxiFd*1KxpJ8zH",baseUrl:"http://120.48.21.232:80",uploadPath:o}}).call(this,"src\\config")},function(e,t,a){"use strict";var i=a(2),s=a(0),o=a.n(s);const n=new(0,i.a.Schema)({tid:{type:String,ref:"post"},cuid:{type:String,ref:"users"},content:{type:String},created:{type:Date},hands:{type:Number,default:0},status:{type:String,default:"1"},isRead:{type:String,default:"0"},isBest:{type:String,default:"0"}});n.pre("save",(function(e){this.created=o()().format("YYYY-MM-DD HH:mm:ss"),e()})),n.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),n.statics={findByTid:function(e){return this.find({tid:e})},findByCid:function(e){return this.findOne({_id:e})},getCommentsList:function(e,t,a){return this.find({tid:e}).populate({path:"cuid",select:"_id name pic isVip",match:{status:{$eq:"0"}}}).populate({path:"tid",select:"_id uid status"}).skip(t*a).limit(a)},queryCont:function(e){return this.find({tid:e}).countDocuments()},getTotal:function(e){return this.find({cuid:e,isRead:"0",status:"1"}).countDocuments()},getMsgList:function(e,t,a){return this.aggregate([{$lookup:{from:"posts",let:{pid:{$toObjectId:"$tid"}},pipeline:[{$match:{$expr:{$eq:["$_id","$$pid"]}}},{$project:{_id:1,uid:1,title:1}}],as:"post"}},{$replaceRoot:{newRoot:{$mergeObjects:[{$arrayElemAt:["$post",0]},"$$ROOT"]}}},{$addFields:{userId:{$toObjectId:"$uid"}}},{$lookup:{from:"users",localField:"userId",foreignField:"_id",as:"tuid"}},{$unwind:"$tuid"},{$addFields:{fuserId:{$toObjectId:"$cuid"}}},{$lookup:{from:"users",localField:"fuserId",foreignField:"_id",as:"fuid"}},{$unwind:"$fuid"},{$project:{post:0,tuid:{username:0,password:0},fuid:{username:0,password:0},userId:0,tid:0,cuid:0}},{$match:{uid:e,status:"1",isRead:"0"}}]).skip(t*a).limit(a)}};const d=i.a.model("comments",n);t.a=d},function(e,t){e.exports=require("koa-router")},function(e,t,a){"use strict";a.d(t,"b",(function(){return c})),a.d(t,"a",(function(){return u}));var i=a(16),s=a.n(i),o=a(15),n=a(3);const d={host:n.a.REDIS.host,port:n.a.REDIS.port,password:n.a.REDIS.password,detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},r=Object(o.promisifyAll)(s.a.createClient(d));r.on("error",e=>{console.log("Redis Client Error:"+e)});const c=(e,t,a)=>{void 0!==t&&null!=t&&""!==t&&("string"==typeof t?void 0!==a?r.set(e,t,"EX",a):r.set(e,t):"object"==typeof t&&Object.keys(t).forEach(a=>{r.hset(e,a,t[a],s.a.print)}))},u=e=>r.getAsync(e)},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("uuid/v4")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("make-dir")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-combine-routers")},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-compose")},function(e,t){e.exports=require("koa-compress")},function(e,t,a){"use strict";t.a=(e,t)=>t().catch(t=>{401==t.status?(e.status=401,e.body={code:401,msg:"Protected resource, use Authorization header to get"}):(e.status=t.status||500,e.body={code:500,msg:t.message})})},function(e,t,a){"use strict";var i=a(14),s=a.n(i),o=a(1),n=a(4);t.a=class{constructor(e={}){const t={port:3001,timeInterval:3e4,isAuth:!0,...e};this.wss={},this.timeInterval=t.timeInterval,this.isAuth=t.isAuth,this.port=t.port,this.options=e.options||{}}init(){this.wss=new s.a.Server({port:this.port,...this.options}),this.heartbeat(),this.wss.on("connection",e=>{e.isAlive=!0,e.on("message",t=>this.onMessage(e,t)),e.on("close",()=>this.onClose(e))})}onMessage(e,t){const a=JSON.parse(t);({auth:async()=>{try{const t=await Object(o.b)(a.msg);if(t){e.isAuth=!0,e._id=t._id;const a=await n.a.getTotal(t._id);e.send(JSON.stringify({event:"message",msg:a}))}}catch(t){e.send(JSON.stringify({event:"noauth",msg:"please auth again"}))}},heartbeat:()=>{"pong"===a.message&&(e.isAlive=!0)},message:()=>{!e.isAuth&&this.isAuth||this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e._id&&this.send(t)})}})[a.event]()}onClose(e){}send(e,t){this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e&&a.send(t)})}broadcast(e){this.wss.clients.forEach(t=>{t.readyState===s.a.OPEN&&t.send(e)})}heartbeat(){clearInterval(this.interval),this.interval=setInterval(()=>{this.wss.clients.forEach(e=>{if(!e.isAlive&&e.roomid)return e.terminate();e.isAlive=!1,e.send(JSON.stringify({event:"heartbeat",msg:"ping"}))})},this.timeInterval)}}},function(e,t,a){"use strict";var i=a(22),s=a.n(i),o=a(5),n=a.n(o),d=a(23),r=a.n(d),c=a(6);var u=new class{constructor(){}async getCaptcha(e){const t=e.request.query,a=r.a.create({size:4,ignoreChars:"0o1il",color:!0,noise:Math.floor(5*Math.random()),width:150});Object(c.b)(t.sid,a.text,600),e.body={code:200,data:a.data}}},p=a(2),l=a(0),m=a.n(l);const g=new(0,p.a.Schema)({title:{type:String,default:""},link:{type:String,default:""},type:{type:String,default:"link"},created:{type:Date},isTop:{type:String,default:""},sort:{type:String,default:""}});g.pre("save",(function(e){this.created=m()(),e()}));var f=p.a.model("links",g);const y=new(0,p.a.Schema)({uid:{type:String,ref:"users"},catalog:{type:String},title:{type:String},content:{type:String},created:{type:Date},fav:{type:String},isEnd:{type:String,default:"0"},reads:{type:Number,default:0},answer:{type:Number,default:0},status:{type:String,default:"0"},isTop:{type:String,default:"0"},sort:{type:String,default:100},tags:{type:Array,ref:"label"}});y.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),y.statics={getList:function(e,t,a,i){return this.find(e).sort({[t]:-1}).skip(a*i).limit(i).populate({path:"uid",select:"name isVip pic"})},getListadm:function(e,t,a){let i={};if(void 0!==e.item&&""!==e.item.trim())if("created"===e.search){const t=e.item[0],a=e.item[1];i={created:{$gte:new Date(t),$lt:new Date(a)}}}else"catalog"===e.search?i={catalog:{$in:e.item}}:"title"===e.search?i[e.search]={$regex:new RegExp(e.item)}:"tags"===e.search?i={tags:{$elemMatch:{name:new RegExp(e.item)}}}:"name"===e.search?(i={uid:{$in:e.item}},console.log(i)):i[e.search]=e.item;return this.find(i).skip(t*a).limit(a).populate({path:"uid",select:"name isVip pic"})},getTopWeek:function(){return this.find({created:{$gte:m()().subtract(7,"days")}},{answer:1,title:1}).sort({answer:-1}).limit(15)},findByTid:function(e){return this.findOne({_id:e}).populate({path:"uid",select:"name pic isVip _id"})},getTopList:function(){return this.find({isTop:"1"})},getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()},countList:function(e){return this.find(e).countDocuments()}};var b=p.a.model("post",y);const h=new(0,p.a.Schema)({classname:{type:String},name:{type:String},created:{type:Date}});h.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),h.statics={getLabel:function(e,t,a,i){let s={};if(void 0!==i.item&&""!==i.item.trim())if("created"===i.search){const e=i.item[0],t=i.item[1];s={created:{$gte:new Date(e),$lt:new Date(t)}}}else"name"===i.search?s[i.search]={$regex:new RegExp(i.item)}:s[i.search]={$in:i.item};return this.find(s).sort({[e]:-1}).skip(t*a).limit(a)},countList:function(){return this.find({}).countDocuments()}};var w=p.a.model("label",h),v=a(11),_=a.n(v),O=a(8),$=a.n(O),Y=a(3),S=a(17),k=a.n(S);const x=new(0,p.a.Schema)({username:{type:String,index:{unique:!0},sparse:!0},password:{type:String},name:{type:String},created:{type:Date},updated:{type:Date},favs:{type:Number,default:10},gender:{type:String},roles:{type:Array,default:["user"]},pic:{type:String,default:"/img/touxiang.jpeg"},mobile:{type:String,match:/^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d{8}$/},status:{type:String,default:"0"},regmark:{type:String,default:""},location:{type:String,default:""},isVip:{type:String,default:"0"},count:{type:Number,default:"0"}});x.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),x.pre("update",(function(e){this.update=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),x.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("Error: Monngoose has a duplicate key.")):a(e)})),x.statics={findByID:function(e){return this.findOne({_id:e},{updated:0,username:0,gender:0})},getList:function(e,t,a){let i={};if(void 0!==a.item&&""!==a.item.trim())if("created"===a.search){const e=a.item[0],t=a.item[1];i={created:{$gte:new Date(e),$lt:new Date(t)}}}else"roles"===a.search?i={roles:{$in:a.item}}:["name","username"].includes(a.search)?i[a.search]={$regex:new RegExp(a.item)}:i[a.search]=a.item;return this.find(i,{password:0,pic:0,count:0,regmark:0}).skip(e*t).limit(t)},getUser:function(e){return this.find({name:{$regex:new RegExp(e.item)}},{_id:1})}};var D=p.a.model("users",x),q=a(1);const M=new(0,p.a.Schema)({tid:{type:String,ref:"post"},uid:{type:String,ref:"users"},title:{type:String},created:{type:Date}});M.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),M.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),M.statics={getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};var j=p.a.model("collects",M),E=a(13),L=a.n(E);var U=new class{async getPostList(e){const t=e.query,a=t.sort?t.sort:"created",i=t.page?parseInt(t.page):0,s=t.limit?parseInt(t.limit):20,o={};void 0!==t.catalog&&""!==t.catalog&&(o.catalog=t.catalog),void 0!==t.isTop&&(o.isTop=t.isTop),void 0!==t.status&&""!==t.status&&(o.status=t.status),void 0!==t.tag&&""!==t.tag&&(o.tags={$elemMatch:{name:t.tag}});const n=await b.getList(o,a,i,s),d=await b.countList(o);e.body={code:200,data:n,msg:"获取文章列表成功",total:d}}async getPostListadm(e){const t=e.query,a=L.a.parse(t),i=a.page?parseInt(a.page):0,s=a.limit?parseInt(a.limit):20;if("name"===a.option.search){const{user:e}=await D.getUser(o);a.option.item=e}const o=a.option||{},n=await b.getListadm(o,i,s),d=n.length;e.body={code:200,data:n,msg:"获取文章列表成功",total:d}}async getTopList(e){const t=await b.getTopList();e.body={code:200,data:t}}async getLinks(e){const t=await f.find({type:"links"});e.body={code:200,data:t}}async getTips(e){const t=await f.find({type:"tips"});e.body={code:200,data:t}}async getTopWeek(e){const t=await b.getTopWeek();e.body={code:200,data:t}}async uploadImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${Y.a.uploadPath}/${m()().format("YYYYMMDD")}`;await k()(i);const s=$()(),o=`${i}/${s}.${a}`,n=_.a.createReadStream(t.path),d=_.a.createWriteStream(o),r=`/${m()().format("YYYYMMDD")}/${s}.${a}`;n.pipe(d);const c=await Object(q.b)(e.header.authorization),u=await D.findOne({_id:c._id});if("/img/touxiang.jpeg"!==u.pic){let e=u.pic;const t=Y.a.uploadPath+e.substr(21);_.a.unlink(t,e=>{if(e)throw e;console.log(t+"was deleted")})}e.body={code:200,msg:"上传成功!",data:r}}async uploadWangImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${Y.a.uploadPath}/${m()().format("YYYYMMDD")}`;await k()(i);const s=$()(),o=`${i}/${s}.${a}`,n=_.a.createReadStream(t.path),d=_.a.createWriteStream(o),r=`/${m()().format("YYYYMMDD")}/${s}.${a}`;n.pipe(d),e.body={code:200,msg:"上传成功!",data:r}}async addPost(e){const{body:t}=e.request,a=t.sid,i=t.code;if(await Object(q.a)(a,i)){const a=await Object(q.b)(e.header.authorization);if((await D.findById({_id:a._id})).favs<t.fav)return void(e.body={code:501,msg:"积分不足"});{await D.updateOne({_id:a._id},{$inc:{favs:-t.fav}});const i=new b(t);i.uid=a._id;await i.save();e.body={code:200,msg:"发帖成功"}}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async getPostDetail(e){const t=e.query;if(!t.tid)return void(e.body={code:500,msg:"文章标题为空"});const a=await b.findByTid(t.tid);if(!a&&void 0!==a&&0!=a)return void(e.body={code:501,msg:"文章不存在"});let i=!1;if(void 0!==e.header.authorization&&""!==e.header.authorization){const a=await Object(q.b)(e.header.authorization),s=await j.findOne({uid:a._id,tid:t.tid});s&&s.tid&&(i=!0)}const s=a.toJSON();s.isCollect=i,e.body={code:200,data:s,msg:"查询文章成功"}}async editPost(e){const{body:t}=e.request,a=await Object(q.b)(e.header.authorization),i=await b.findOne({_id:t.tid});if(i.uid===a._id&&"0"===i.isEnd){const a=await b.updateOne({_id:t.tid},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}else e.body={code:401,msg:"修改失败"}}async editPostbyId(e){const{body:t}=e.request,a=await b.updateOne({_id:t._id},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}async getPostListByUid(e){const t=e.query,a=await Object(q.b)(e.header.authorization),i=await b.getListByUid(a._id,t.page,10),s=await b.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}async deletePostByTid(e){const t=e.query,a=await Object(q.b)(e.header.authorization);if((await b.findOne({uid:a._id,_id:t.tid})).uid===a._id){const a=await b.deleteOne({_id:t.tid}),i=await j.deleteOne({tid:t.tid});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}else e.body={code:500,msg:"删除失败,无权限"}}async getColleByUid(e){const t=e.query,a=await Object(q.b)(e.header.authorization),i=await j.getListByUid(a._id,t.page,10),s=await j.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}async deletepost(e){const t=e.query,a=await b.deleteOne({_id:t.tid}),i=await j.deleteOne({tid:t.tid});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async getLabel(e){const t=e.query,a=L.a.parse(t),i=a.sort?a.sort:"created",s=a.page?parseInt(a.page):0,o=a.limit?parseInt(a.limit):10,n=a.option||{},d=await w.getLabel(i,s,o,n),r=d.length;e.body={code:200,data:d,msg:"获取文章列表成功",total:r}}async addLabel(e){const{body:t}=e.request,a=new w(t),i=await a.save();e.body={code:200,data:i,msg:"新增成功"}}async deleteLabel(e){const t=e.query;1===(await w.deleteOne({_id:t._id})).ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async editLabel(e){const{body:t}=e.request,a=await w.updateOne({_id:t._id},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}};const I=new(0,p.a.Schema)({uid:{type:String,ref:"users"},created:{type:Date},favs:{type:Number}});I.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),I.statics={findByUid:function(e){return this.findOne({uid:e}).sort({created:-1})}};var T=p.a.model("sign_record",I),C=a(24),B=a.n(C);var P=async function(e){let t=B.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"2116615470@qq.com",pass:"hpxfsublqlnmecfe"}}),a=`${Y.a.baseUrl}/#${"email"===e.type?"/confirm":"/reset"}?`+L.a.stringify(e.data);return(await t.sendMail({from:'"认证邮件" <2116615470@qq.com>',to:e.email,subject:""!==e.user&&"email"!==e.type?`你好${e.user}！确认修改密码链接`:"《Fly社区》确认修改邮箱链接",text:`您在《Fly社区》中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Fly社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user},重置链接有效时间30分钟，请在${e.expire}之前重置您的密码：</div>\n          <a href="${a}" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">立即重置</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId},R=a(9),z=a.n(R),H=a(7),N=a.n(H),J=a(4);var W=new class{async userSign(e){const t=await Object(q.b)(e.header.authorization),a=await T.findByUid(t._id),i=await D.findByID(t._id);let s={},o="";if(null!==a){if(m()(a.created).format("YYYY-MM-DD")===m()().format("YYYY-MM-DD"))return void(e.body={code:500,msg:"已签到",favs:i.favs,count:i.count});{let e=i.count,n=0;m()(a.created).format("YYYY-MM-DD")===m()().subtract(1,"days").format("YYYY-MM-DD")?(e+=1,n=e<=10?5:e>10&&e<=20?10:e>20&&e<=40?15:20,await D.updateOne({_id:t._id},{$inc:{count:1,favs:n}}),o={favs:i.favs+n,count:i.count+1}):(await D.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),o={favs:i.favs+n,count:1},n=5),s=new T({uid:t._id,favs:n}),await s.save()}}else await D.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),s=new T({uid:t._id,favs:5}),await s.save(),o={favs:i.favs+5,count:1};e.body={code:200,msg:"cg",...o}}async updateUserInfo(e){const{body:t}=e.request,a=await Object(q.b)(e.header.authorization),i=await D.findOne({_id:a._id});let s="";if(t.username!==i.username&&!t.pic){const o=await D.findOne({username:a.username});if(o&&o.password)return void(e.body={code:501,msg:"用户名已存在/邮箱已被注册"});const n=$()();Object(c.b)(n,z.a.sign({_id:a._id},Y.a.JWT_SERCET,{expiresIn:"30m"}));await P({type:"email",data:{key:n,username:t.username},code:"",expire:m()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:i.username,user:i.name});s="基本信息已修改成功,用户名修改请到发送的邮件修改"}["username","password","mobile"].map(e=>{delete t[e]});const o=await D.updateOne({_id:a._id},t);1===o.n&&1===o.ok?e.body={code:200,msg:""===s?"更新成功":s}:e.body={code:500,msg:更新失败}}async updateUsername(e){const t=e.query;if(t.key){const a=await Object(c.a)(t.key),i=Object(q.b)("Bearer "+a);await D.updateOne({_id:i._id},{username:t.username}),e.body={code:200,msg:"更新用户名成功!"}}}async updateUserpass(e){const t=e.query;if(t.key){const a=await Object(c.a)(t.key),i=Object(q.b)("Bearer "+a),s=await N.a.hash(t.password,5);await D.updateOne({_id:i._id},{password:s}),e.body={code:200,msg:"更新密码成功!"}}}async changepw(e){const{body:t}=e.request,a=await Object(q.b)(e.header.authorization),i=await D.findOne({_id:a._id});if(await N.a.compare(t.oldpwd,i.password)){const i=await N.a.hash(t.password,5);await D.updateOne({_id:a._id},{$set:{password:i}}),e.body={code:200,msg:"更改密码成功!"}}else e.body={code:500,msg:"您输入的原密码不正确!"}}async collect(e){}async setCollect(e){const t=e.query,a=await Object(q.b)(e.header.authorization);if(parseInt(t.isCollect))await j.deleteOne({uid:a._id,tid:t.tid}),e.body={code:200,msg:"取消收藏成功"};else{const i=new j({uid:a._id,tid:t.tid,title:t.title});(await i.save()).uid?e.body={code:200,msg:"收藏成功"}:e.body={code:400,msg:"收藏失败"}}}async getmsg(e){const t=e.query,a=t.page?t.page:0,i=await Object(q.b)(e.header.authorization),s=await J.a.getMsgList(i._id,a,6);e.body={code:200,data:s}}async getinfo(e){const t=await Object(q.b)(e.header.authorization),a=(await D.findOne({_id:t._id})).toJSON();["password","username"].map(e=>{delete a[e]}),e.body={code:200,data:a}}async getUserList(e){const{body:t}=e.request,a=t.page?parseInt(t.page):0,i=t.limit?parseInt(t.limit):10,s=t.option||{},o=await D.getList(a,i,s),n=o.length;e.body={code:200,data:o,total:n}}async editUser(e){const{body:t}=e.request;if(await D.findOne({_id:t._id})){t.password?t.password=await N.a.hash(t.password,5):delete t.password;const a=await D.updateOne({_id:t._id},t);1===a.n&&1===a.ok?e.body={code:200,msg:"更新成功"}:e.body={code:500,msg:"更新失败"}}}async batchUpdateUser(e){const{body:t}=e.request,a=await D.updateMany({_id:{$in:t.ids}},{$set:{...t.set}});1===a.ok&&(e.body={code:200,data:a})}async deleteUser(e){const{body:t}=e.request;1===(await D.deleteMany({_id:{$in:t}})).ok?e.body={code:200,msg:"删除成功!"}:e.body={code:500,msg:"删除失败!"}}async checkName(e){const t=e.query,a=await D.findOne({name:t.name});e.body=a?{code:500,msg:"昵称重复!"}:{code:200,msg:"昵称有效!"}}async checkUsername(e){const t=e.query,a=await D.findOne({username:t.username});e.body=a?{code:500,msg:"邮箱重复!"}:{code:200,msg:"邮箱有效!"}}async addUser(e){const{body:t}=e.request;t.password=await N.a.hash(t.password,5);const a=new D(t),i=await a.save();e.body={code:200,msg:"新增用户成功",data:i}}};const A=new(0,p.a.Schema)({uid:{type:String},cid:{type:String},created:{type:Date}});A.pre("save",(function(e){this.created=m()().format("YYYY-MM-DD HH:mm:ss"),e()})),A.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),A.statics={findByCid:function(e){return this.find({cid:e})}};var F=p.a.model("Comments_Hands",A);var V=new class{async getComments(e){const t=e.query,a=t.tid,i=t.page?t.page:0;let s=await J.a.getCommentsList(a,i,10);const o=await J.a.queryCont(a);let n={};if(void 0!==e.header.authorization&&(n=await Object(q.b)(e.header.authorization)),void 0!==n){s=s.map(e=>e.toJSON());for(let e=0;e<s.length;e++){let t=s[e];t.handed="0";const a=await F.findOne({cid:t._id,uid:n._id});a&&a.cid&&a.uid===n._id&&(t.handed="1")}}1===(await b.updateOne({_id:t.tid},{$inc:{reads:1}})).ok?e.body={code:200,total:o,data:s,msg:"查询成功"}:e.body={code:500,msg:"查询失败"}}async addComment(e){if(await(async e=>{let t=!0;const a=await Object(q.b)(e.header.authorization);if(void 0===a._id)return t;return"0"===(await D.findByID(a._id)).status&&(t=!1),t})(e))return void(e.body={code:500,msg:"用户已被禁言!"});const{body:t}=e.request,a=await b.findOne({_id:t.tid});if(1===a.status)return void(e.body={code:500,msg:"评论失败,此贴禁止评论"});const i=new J.a(t),s=await Object(q.b)(e.header.authorization);i.cuid=s._id,i.uid=a.uid;const o=await i.save(),n=await J.a.getTotal(a.uid);global.ws.send(a.uid,JSON.stringify({event:"message",msg:n}));1===(await b.updateOne({_id:t.tid},{$inc:{answer:1}})).ok?e.body={code:200,data:o,msg:"评论成功"}:e.body={code:500,data:o,msg:"评论失败"}}async setBest(e){const t=await Object(q.b)(e.header.authorization);if(void 0===t&&""!==t._id)return void(e.body={code:401,msg:"用户未登录,或者未授权"});const a=e.query,i=await b.findOne({_id:a.tid}),s=await J.a.findByCid(a.cid);if(s.cuid!==t._id)if(i.uid===t._id&&"0"===i.isEnd){const t=await b.updateOne({_id:a.tid},{$set:{isEnd:"1"}}),o=await J.a.updateOne({_id:a.cid},{$set:{isBest:"1"}});if(1===t.ok&&1===o.ok){1===(await D.updateOne({_id:s.cuid},{$inc:{favs:parseInt(i.fav)}})).ok?e.body={code:200,msg:"设置成功"}:e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"帖子已结贴或重复设置"};else e.body={code:500,msg:"不能给自己的评论设置最佳"}}async setHands(e){const t=await Object(q.b)(e.header.authorization),a=e.query;if((await F.find({cid:a.cid,uid:t._id})).length>0)return void(e.body={code:500,msg:"重复点赞"});const i=new F({cid:a.cid,uid:t._id});await i.save();1===(await J.a.updateOne({_id:a.cid},{$inc:{hands:1}})).ok?e.body={code:200,msg:"点赞成功"}:e.body={code:500,msg:"点赞失败"}}};const K=new n.a;K.prefix("/public"),K.get("/list",U.getPostList),K.get("/adlist",U.getPostListadm),K.get("/topList",U.getTopList),K.get("/getCaptcha",u.getCaptcha),K.get("/tips",U.getTips),K.get("/links",U.getLinks),K.get("/topWeek",U.getTopWeek),K.get("/setEmail",W.updateUsername),K.get("/setPass",W.updateUserpass),K.get("/content/detail",U.getPostDetail),K.get("/comments",V.getComments),K.get("/getinfo",W.getinfo),K.get("/getlabel",U.getLabel);var Q=K;a(15);var X=new class{async forget(e){const{body:t}=e.request,a=t.sid,i=t.code,s=await Object(q.a)(a,i),o=await D.findOne({username:t.username});if(s)if(o){const a=$()();Object(c.b)(a,z.a.sign({_id:o._id},Y.a.JWT_SERCET,{expiresIn:"30m"}));await P({type:"forget",code:"",data:{key:a,username:t.username},expire:m()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:o.name});e.body={code:200,msg:"邮件发送成功,请查收更改密码"}}else e.body={code:500,msg:"用户名不存在"};else e.body={code:401,msg:"图片验证码不正确或已失效"}}async login(e){const{body:t}=e.request;let a=t.sid,i=t.code;if(await Object(q.a)(a,i)){let a=!1,i=await D.findOne({username:t.username});if(await N.a.compare(t.password,i.password)&&(a=!0),a){const t=i.toJSON();["password","username"].map(e=>{delete t[e]});const a=z.a.sign({_id:t._id},Y.a.JWT_SERCET,{expiresIn:"7d"}),s=await T.findByUid(t._id);null!==s&&m()(s.created).format("YYYY-MM-DD")===m()().format("YYYY-MM-DD")?t.isSign=!0:t.isSign=!1,e.body={code:200,token:a,data:t}}else e.body={code:404,msg:"用户名/密码验证失败"}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async reg(e){let{body:t}=e.request,a=t.sid,i=t.code,s={},o=!0;if(await Object(q.a)(a,i)){let a=await D.findOne({username:t.username});null!==a&&void 0!==a.username&&(s.username=["此邮箱已被注册,可以通过忘记密码找回"],o=!1);let i=await D.findOne({name:t.name});if(null!==i&&void 0!==i.name&&(s.name=["此昵称已被注册"],o=!1),o){t.password=await N.a.hash(t.password,5);let a=new D({username:t.username,name:t.name,password:t.password,created:m()().format("YYYY-MM-DD HH:mm:ss")}),i=await a.save();return void(e.body={code:200,data:i,msg:"注册成功"})}}else s.code=["图片验证码不正确或已失效"];e.body={code:500,msg:s}}};const G=new n.a;G.prefix("/login"),G.post("/forget",X.forget),G.post("/login",X.login),G.post("/reg",X.reg);var Z=G;const ee=new n.a;ee.prefix("/user"),ee.get("/fav",W.userSign),ee.post("/basic",W.updateUserInfo),ee.post("/changepw",W.changepw),ee.get("/Collect",W.collect),ee.get("/setCollect",W.setCollect),ee.get("/post",U.getPostListByUid),ee.get("/deletePost",U.deletePostByTid),ee.get("/getColleList",U.getColleByUid),ee.get("/getmsg",W.getmsg),ee.post("/getuserlist",W.getUserList),ee.post("/edituser",W.editUser),ee.post("/batchupdate",W.batchUpdateUser),ee.post("/deleteuser",W.deleteUser),ee.get("/checkusername",W.checkUsername),ee.get("/checkname",W.checkName),ee.post("/addUser",W.addUser);var te=ee;const ae=new n.a;ae.prefix("/content"),ae.post("/upload",U.uploadImg),ae.post("/add",U.addPost),ae.post("/uploadWang",U.uploadWangImg),ae.post("/editpost",U.editPost),ae.get("/deletepost",U.deletepost),ae.post("/editpostbyid",U.editPostbyId),ae.post("/addLabel",U.addLabel),ae.post("/editLabel",U.editLabel),ae.get("/deletelabel",U.deleteLabel);var ie=ae;const se=new n.a;se.prefix("/comments"),se.post("/reply",V.addComment),se.get("/accept",V.setBest),se.get("/sethands",V.setHands);var oe=se;t.a=s()(Q,Z,te,ie,oe)},function(e,t,a){"use strict";a.r(t),function(e){var t=a(18),i=a.n(t),s=a(19),o=a.n(s),n=a(12),d=a.n(n),r=a(20),c=a.n(r),u=a(21),p=a.n(u),l=a(32),m=a(25),g=a.n(m),f=a(26),y=a.n(f),b=a(27),h=a.n(b),w=a(28),v=a.n(w),_=(a(29),a(3)),O=a(30),$=a(31);const Y=new i.a,S=new $.a;S.init(),global.ws=S;const k=o()({secret:_.a.JWT_SERCET}).unless({path:[/^\/public/,/\/login/]}),x=v()([g()({multipart:!0,formidable:{keepExtensions:!0,maxFieldsSize:5242880},onError:e=>{console.log(e)}}),p()(d.a.join(e,"../public")),h()(),y()({pretty:!1,param:"pretty"}),c()(),k,O.a]);Y.use(x),Y.use(Object(l.a)()),Y.listen(3e3)}.call(this,"src")}]);