!function(e){var t={};function a(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(i,s,function(t){return e[t]}.bind(null,s));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=48)}([function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s),o=a(2);const d=new(0,i.a.Schema)({username:{type:String,index:{unique:!0},sparse:!0},password:{type:String},name:{type:String},favs:{type:Number,default:10},gender:{type:String},roles:{type:String,default:"user"},pic:{type:String,default:"/img/touxiang.jpeg"},mobile:{type:String,match:/^1[3-9](\d{9})$/,default:""},status:{type:String,default:"0"},regmark:{type:String,default:""},location:{type:String,default:""},isVip:{type:String,default:"0"},count:{type:Number,default:"0"},openid:{type:String,default:""},unionid:{type:String,default:""}},{timestamps:{createdAt:"created",updatedAt:"updated"}});d.pre("save",(function(e){this.created=n()().format("YYYY-MM-DD HH:mm:ss"),e()})),d.pre("update",(function(e){this.update=n()().format("YYYY-MM-DD HH:mm:ss"),e()})),d.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("Error: Monngoose has a duplicate key.")):a(e)})),d.statics={findByID:function(e){return this.findOne({_id:e},{updated:0,username:0,gender:0,password:0,unionid:0,mobile:0,openid:0,roles:0})},getList:function(e,t,a){let i={};if(void 0!==a.item&&""!==a.item.trim())if("created"===a.search){const e=a.item[0],t=a.item[1];i={created:{$gte:new Date(e),$lt:new Date(t)}}}else"roles"===a.search?i={roles:{$in:a.item}}:["name","username"].includes(a.search)?i[a.search]={$regex:new RegExp(a.item)}:i[a.search]=a.item;return this.find(i,{password:0,pic:0,count:0,regmark:0}).skip(e*t).limit(t)},getListCount:function(e){let t={};if(void 0!==e.item&&""!==e.item.trim())if("created"===e.search){const a=e.item[0],i=e.item[1];t={created:{$gte:new Date(a),$lt:new Date(i)}}}else"roles"===e.search?t={roles:{$in:e.item}}:["name","username"].includes(e.search)?t[e.search]={$regex:new RegExp(e.item)}:t[e.search]=e.item;return this.find(t).countDocuments()},getUser:function(e){return this.find({name:{$regex:new RegExp(e.item)}},{_id:1})},findOrCreatedByOpenData:function(e){return this.findOne({openid:e.openId},{unionid:0,password:0,openid:0}).then(t=>t||this.create({openid:e.openId,unionid:e.unionId,username:Object(o.f)(),name:e.nickName,gender:e.gender,pic:e.avatarUrl,location:e.city}))}};const r=i.a.model("users",d);t.a=r},function(e,t){e.exports=require("dayjs")},function(e,t,a){"use strict";a.d(t,"a",(function(){return c})),a.d(t,"c",(function(){return d})),a.d(t,"d",(function(){return l})),a.d(t,"g",(function(){return u})),a.d(t,"e",(function(){return p})),a.d(t,"f",(function(){return m})),a.d(t,"b",(function(){return r}));var i=a(8),s=a(4),n=a(14),o=a.n(n);const d=e=>o.a.verify(e.split(" ")[1],s.a.JWT_SERCET),r=e=>{if(e)return o.a.sign({...e},s.a.JWT_SERCET,{expiresIn:"7d"});throw new Error("生成token失败!")},c=async(e,t)=>{const a=await Object(i.a)(e);return null!=a&&a.toLowerCase()==t.toLowerCase()},u=(e,t)=>e.sort((e,a)=>e[t]-a[t]),l=(e,t,a)=>{const i=[];for(let s=0;s<e.length;s++){const n=e[s];(t.includes(n._id)||a)&&("menu"===n.type?i.push({_id:n._id,path:n.path,meta:{title:n.title,hidelnBread:n.hidelnBread,hidelnMenu:n.hidelnMenu,notCache:n.notCache,icon:n.icon},component:n.component,children:l(n.children,t)}):"link"===n.type&&i.push({_id:n._id,path:n.path,meta:{title:n.title,icon:n.icon,href:n.link}}))}return u(i,"sort")},p=(e,t)=>{let a=[];for(const i of e)if(i.operations&&i.operations.length>0)for(const e of i.operations)t.includes(e._id+"")&&a.push(e.path);else i.children&&i.children.length>0&&a.push(p(i.children,t));return a.flat(1/0)},m=()=>"temp_"+(()=>{let e="";for(let t=0;t<9;t++)e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz0123456789".charAt(Math.floor(math.random()));return e})()+"@js.com"},function(e,t,a){"use strict";var i=a(18),s=a.n(i),n=a(4);s.a.set("useCreateIndex",!0),s.a.connect(n.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),s.a.connection.on("connected",()=>{console.log("Mongoose connection open to "+n.a.DB_URL)}),s.a.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),s.a.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")}),t.a=s.a},function(e,t,a){"use strict";a(16);t.a={DB_URL:"mongodb://test:password@120.48.21.232:39875/testdb",REDIS:{host:"120.48.21.232",port:6379,password:"123456"},JWT_SERCET:"F&l8mWkDt$9a1lQBuaej9oJ2T35@u7ur69szx6smKJINzMbUYjHxiFd*1KxpJ8zH",baseUrl:"https://www.toped.top",uploadPath:"public",adminEmail:["378091429@qq.com"],publicPath:[/^\/public/,/\/login/,/^\/content/],AppId:"wx45c9da8b092c8330",AppSecret:"8dad43e742ce7fec101bb1df8651cd7c"}},function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s);const o=new(0,i.a.Schema)({uid:{type:String,ref:"users"},catalog:{type:String},title:{type:String},content:{type:String},created:{type:Date},fav:{type:String},isEnd:{type:String,default:"0"},reads:{type:Number,default:0},answer:{type:Number,default:0},status:{type:String,default:"0"},isTop:{type:String,default:"0"},sort:{type:String,default:100},tags:{type:Array,ref:"label"},pic:{type:String,default:""},likes:{type:Number,default:0}});o.pre("save",(function(e){this.created=n()().format("YYYY-MM-DD HH:mm:ss"),e()})),o.statics={getList:function(e,t,a,i){return this.find(e).sort({[t]:-1}).skip(a*i).limit(i).populate({path:"uid",select:"name isVip pic"})},getListCount:function(e){return this.find(e).countDocuments()},getListadm:function(e,t,a){let i={};if(void 0!==e.item&&""!==e.item)if("created"===e.search){const t=e.item[0],a=e.item[1];i={created:{$gte:new Date(t),$lt:new Date(a)}}}else"catalog"===e.search?i={catalog:{$in:e.item}}:"title"===e.search?i[e.search]={$regex:new RegExp(e.item)}:"tags"===e.search?i={tags:{$elemMatch:{name:new RegExp(e.item)}}}:"name"===e.search?i={uid:{$in:e.item}}:i[e.search]=e.item;return this.find(i).skip(t*a).limit(a).populate({path:"uid",select:"name isVip pic"}).sort({created:-1})},getTopWeek:function(){return this.find({created:{$gte:n()().subtract(7,"days")}},{title:1}).sort({answer:-1}).limit(7)},findByTid:function(e){return this.findOne({_id:e}).populate({path:"uid",select:"name pic isVip _id"})},getTopList:function(){return this.find({isTop:"1"})},getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()},countList:function(e){let t={};if(void 0!==e.item&&""!==e.item)if("created"===e.search){const a=e.item[0],i=e.item[1];t={created:{$gte:new Date(a),$lt:new Date(i)}}}else"catalog"===e.search?t={catalog:{$in:e.item}}:"title"===e.search?t[e.search]={$regex:new RegExp(e.item)}:"tags"===e.search?t={tags:{$elemMatch:{name:new RegExp(e.item)}}}:"name"===e.search?t={uid:{$in:e.item}}:t[e.search]=e.item;return this.find(t).countDocuments()}};const d=i.a.model("post",o);t.a=d},function(e,t,a){"use strict";var i=a(3);const s=i.a.Schema,n=new s({title:{type:String,default:""},name:{type:String,default:""},path:{type:String,default:""},component:{type:String,default:""},hidelnBread:{type:Boolean,default:!1},hidelnMenu:{type:Boolean,default:!1},notCache:{type:Boolean,default:!1},icon:{type:String,default:""},sort:{type:String,default:""},link:{type:String,default:""},redirect:{type:String,default:""},children:{type:String,default:""},type:{type:String,default:""},expand:{type:Boolean,default:!0}}),o=new s({name:{type:String,default:""},type:{type:String,default:""},method:{type:String,default:""},path:{type:String,default:""},regmark:{type:String,default:""}});n.add({children:[n],operations:[o]});var d=i.a.model("menus",n);const r=new(0,i.a.Schema)({name:{type:String,default:""},roles:{type:String,default:""},desc:{type:String,default:""},menu:{type:Array,default:[]}});var c=i.a.model("roles",r),u=a(7),l=a(0),p=a(5),m=a(23),g=a(15),f=a(2),y=a(1),h=a.n(y),w=a(4),b=a(22),v=a.n(b),_=a(11),$=a.n(_),O=a(9),S=a.n(O),q=a(13);let x=a(49);h.a.extend(x);t.a=new class{async addMenu(e){const{body:t}=e.request,a=new d(t),i=await a.save();e.body={code:200,data:i}}async deleteMenu(e){const t=e.query;let a=await d.deleteOne({_id:t._id});e.body={code:200,data:a}}async updataMenu(e){const{body:t}=e.request,a={...t};delete a._id;const i=await d.updateOne({_id:t._id},{...a});e.body={code:200,data:i}}async getMenus(e){const t=await d.find({}).sort({sort:-1}),a=Object(f.g)(t,"sort");e.body={code:200,data:a}}async addRoles(e){const{body:t}=e.request,a=new c(t),i=await a.save();e.body={code:200,data:i}}async deleteRoles(e){const t=e.query,a=await c.deleteOne({_id:t._id});e.body={code:200,data:a}}async updataRoles(e){const{body:t}=e.request,a={...t};delete a._id;const i=await c.updateOne({_id:t._id},{...a});e.body={code:200,data:i}}async getRoles(e){const t=await c.find({});e.body={code:200,data:t}}async getRolesName(e){const t=await c.find({},{menu:0,desc:0});e.body={code:200,data:t}}async getcomment(e){const{body:t}=e.request,a=t.page?parseInt(t.page):0,i=t.limit?parseInt(t.limit):10,s=t.option||{};let n=await u.a.getList(a,i,s);if("user"===s.search)for(let e=0;e<n.length;e++)null!==n[e].cuid&&(n=n.slice(e,e+1));else if("title"===s.search)for(let e=0;e<n.length;e++)null!==n[e].tid&&(n=n.slice(e,e+1));const o=await u.a.getTotalAll();e.body={code:200,data:n,msg:"获取文章列表成功",total:o}}async editComment(e){const{body:t}=e.request,a={...t},i=await u.a.updateOne({_id:t._id},{...a});e.body={code:200,data:i}}async deleteComment(e){const t=e.query,a=await u.a.deleteOne({_id:t._id});e.body={code:200,data:a}}async batchDeleteComment(e){const{body:t}=e.request;1===(await u.a.deleteMany({_id:{$in:t}})).ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async batchEditComment(e){const{body:t}=e.request,a=await u.a.updateMany({_id:{$in:t.ids}},{$set:{...t.data}});1===a.ok&&(e.body={code:200,data:a})}async getRoutes(e){const t=await l.a.findOne({_id:e._id},{roles:1}),{role:a}=t,i=(await c.findOne({role:a},{menu:1})).menu,s=await d.find({}),n=Object(f.d)(s,i,e.isAdmin);e.body={code:200,data:n}}async getOperations(e){const t=await l.a.findOne({_id:e._id},{roles:1}),{roles:a}=t,i=(await c.findOne({roles:a},{menu:1})).menu,s=await d.find({});return Object(f.e)(s,i)}async getStats(e){const t=[],a=(new Date).setHours(0,0,0,0),i=h()(a).weekday(1).format(),s=await l.a.find({}).countDocuments(),n=await l.a.find({created:{$gte:i}}).countDocuments(),o=await p.a.find({}).countDocuments(),d=await l.a.find({created:{$gte:i}}).countDocuments(),r=await u.a.find({}).countDocuments(),c=await u.a.find({created:{$gte:i}}).countDocuments(),m=await p.a.find({},{reads:1,_id:0});let f=0;for(let e=0;e<m.length;e++)f+=m[e].reads;const y=await p.a.find({created:{$gte:i}},{reads:1,_id:0});let w=0;for(let e=0;e<y.length;e++)w+=y[e].reads;const b=h()(a).weekday(1).format(),v=h()(a).weekday(8).format(),_=await g.a.find({created:{$gte:b,$lte:v}}).countDocuments(),$=await p.a.find({created:{$gte:b,$lte:v}}).countDocuments();t.push([s,n],[o,d],[r,c],[f,w],[_,_],[$,$]);const O=await p.a.aggregate([{$group:{_id:"$catalog",count:{$sum:1}}}]);let S={};O.forEach(e=>{S[e._id]=e.count});const q=h()(a).subtract(5,"M").date(1).format(),x=h()(a).add(1,"M").date(1).format();let k=await p.a.aggregate([{$match:{created:{$gte:new Date(q),$lt:new Date(x)}}},{$project:{month:{$dateToString:{format:"%Y-%m",date:"$created"}}}},{$group:{_id:"$month",count:{$sum:1}}},{$sort:{_id:1}}]);k=k.reduce((e,t)=>({...e,[t._id]:t.count}),{}),e.body={code:200,data:t,data2:S,data3:k}}async getLogs(e){const t=e.query,a=t.page?parseInt(t.page):0,i=t.limit?parseInt(t.limit):10,s=await m.a.getList(a,i);e.body={code:200,data:s}}async deleteLogs(e){const{body:t}=e.request,a=await m.a.deleteMany({_id:{$in:t.ids}});e.body={code:200,data:a}}async uploadImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=w.a.uploadPath+"/advert";await v()(i);const s=$()(),n=`${i}/${s}.${a}`,o=S.a.createReadStream(t.path),d=S.a.createWriteStream(n),r=`/advert/${s}.${a}`;o.pipe(d),e.body={code:200,msg:"上传成功!",data:r}}async uploadAdvert(e){const{body:t}=e.request,a=new q.a(t),i=await a.save();e.body={code:200,msg:"上传更新成功",data:i}}async deleteAdvert(e){const{body:t}=e.request,a=await q.a.deleteMany({_id:{$in:t}});e.body={code:200,data:a}}}},function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s);const o=new(0,i.a.Schema)({tid:{type:String,ref:"post"},cuid:{type:String,ref:"users"},content:{type:String},created:{type:Date},hands:{type:Number,default:0},status:{type:String,default:"1"},isRead:{type:String,default:"0"},isBest:{type:String,default:"0"}});o.pre("save",(function(e){this.created=n()().format("YYYY-MM-DD HH:mm:ss"),e()})),o.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),o.statics={findByTid:function(e){return this.find({tid:e})},findByCid:function(e){return this.findOne({_id:e})},getCommentsList:function(e,t,a){return this.find({tid:e}).populate({path:"cuid",select:"_id name pic isVip",match:{status:{$eq:"0"}}}).populate({path:"tid",select:"_id uid status"}).skip(t*a).limit(a)},getList:function(e,t,a){let i={},s={},n={};if(void 0!==a.item&&""!==a.item.trim())if("created"===a.search){const e=a.item[0],t=a.item[1];i={created:{$gte:new Date(e),$lt:new Date(t)}}}else"status"===a.search?i={status:{$eq:a.item}}:"isRead"===a.search?i={isRead:{$eq:a.item}}:"isBest"===a.search?i={isBest:{$eq:a.item}}:"content"===a.search?i[a.search]={$regex:new RegExp(a.item)}:"title"===a.search?s[a.search]={$regex:new RegExp(a.item)}:"user"===a.search?n[a.search]={$regex:new RegExp(a.item)}:i[a.search]=a.item;return this.find(i).populate({path:"cuid",select:"_id name",match:n}).populate({path:"tid",select:"_id title",match:s}).skip(e*t).limit(t)},queryCont:function(e){return this.find({tid:e}).countDocuments()},getTotal:function(e){return this.find({cuid:e,isRead:"0",status:"1"}).countDocuments()},getTotalAll:function(){return this.find({isRead:"0",status:"1"}).countDocuments()},getMsgList:function(e,t,a){return this.aggregate([{$lookup:{from:"posts",let:{pid:{$toObjectId:"$tid"}},pipeline:[{$match:{$expr:{$eq:["$_id","$$pid"]}}},{$project:{_id:1,uid:1,title:1}}],as:"post"}},{$replaceRoot:{newRoot:{$mergeObjects:[{$arrayElemAt:["$post",0]},"$$ROOT"]}}},{$addFields:{userId:{$toObjectId:"$uid"}}},{$lookup:{from:"users",localField:"userId",foreignField:"_id",as:"tuid"}},{$unwind:"$tuid"},{$addFields:{fuserId:{$toObjectId:"$cuid"}}},{$lookup:{from:"users",localField:"fuserId",foreignField:"_id",as:"fuid"}},{$unwind:"$fuid"},{$project:{post:0,tuid:{username:0,password:0},fuid:{username:0,password:0},userId:0,tid:0,cuid:0}},{$match:{uid:e,status:"1",isRead:"0"}}]).skip(t*a).limit(a)}};const d=i.a.model("comments",o);t.a=d},function(e,t,a){"use strict";a.d(t,"b",(function(){return c})),a.d(t,"a",(function(){return u}));var i=a(25),s=a.n(i),n=a(35),o=a(4);const d={host:o.a.REDIS.host,port:o.a.REDIS.port,password:o.a.REDIS.password,detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},r=Object(n.promisifyAll)(s.a.createClient(d));r.on("error",e=>{console.log("Redis Client Error:"+e)});const c=(e,t,a)=>{void 0!==t&&null!=t&&""!==t&&("string"==typeof t?void 0!==a?r.set(e,t,"EX",a):r.set(e,t):"object"==typeof t&&Object.keys(t).forEach(a=>{r.hset(e,a,t[a],s.a.print)}))},u=e=>r.getAsync(e)},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("uuid/v4")},function(e,t){e.exports=require("bcryptjs")},function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s);const o=new(0,i.a.Schema)({title:{type:String,default:""},link:{type:String,default:""},type:{type:String,default:""},created:{type:Date},tid:{type:String,default:""}});o.pre("save",(function(e){this.created=n()(),e()}));const d=i.a.model("links",o);t.a=d},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s);const o=new(0,i.a.Schema)({uid:{type:String,ref:"users"},created:{type:Date},favs:{type:Number}});o.pre("save",(function(e){this.created=n()().format("YYYY-MM-DD HH:mm:ss"),e()})),o.statics={findByUid:function(e){return this.findOne({uid:e}).sort({created:-1})}};const d=i.a.model("sign_record",o);t.a=d},function(e,t){e.exports=require("path")},function(e,t,a){"use strict";var i=a(27),s=a.n(i);s.a.configure({appenders:{access:{type:"dateFile",filename:"logs/access.log",pattern:"-yyyy-MM-dd.log"},application:{type:"dateFile",filename:"logs/app.log",pattern:"-yyyy-MM-dd.log"},error:{type:"dateFile",filename:"logs/error.log",pattern:"-yyyy-MM-dd.log"},out:{type:"console"}},categories:{default:{appenders:["out"],level:"info"},access:{appenders:["access"],level:"info"},application:{appenders:["application"],level:"warn"},error:{appenders:["error"],level:"warn"}}}),t.a=s.a},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("make-dir")},function(e,t,a){"use strict";var i=a(3),s=a(1),n=a.n(s);const o=i.a.Schema,d=new o({message:{type:String,default:""},code:{type:String,default:""},method:{type:String,default:""},path:{type:String,default:""},param:{type:o.Types.Mixed,default:""},username:{type:String,default:""},stack:{type:String,default:""},created:{type:Date}});d.pre("save",(function(e){this.created=n()(),e()})),d.statics={getList:function(e,t){return this.find({}).skip(e*t).limit(t)}};const r=i.a.model("logs",d);t.a=r},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("xss")},function(e,t){e.exports=require("koa-log4")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-combine-routers")},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("nodemailer")},function(e,t,a){var i=a(24);function s(e,t){this.appId=e,this.sessionKey=t}s.prototype.decryptData=function(e,t){var a=Buffer.from(this.sessionKey,"base64");e=Buffer.from(e,"base64"),t=Buffer.from(t,"base64");try{var s=i.createDecipheriv("aes-128-cbc",a,t);s.setAutoPadding(!0);var n=s.update(e,"binary","utf8");n+=s.final("utf8"),n=JSON.parse(n)}catch(e){throw new Error("Illegal Buffer")}if(n.watermark.appid!==this.appId)throw new Error("Illegal Buffer");return n},e.exports=s},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-compose")},function(e,t){e.exports=require("koa-compress")},function(e,t,a){"use strict";var i=a(17),s=a(23),n=a(0);const o=i.a.getLogger("error");t.a=async(e,t)=>{try{await t()}catch(t){o.error(`${e.url} ${e.method} ${e.status} ${t.stack}`);let a="";e._id&&(a=await n.a.findOne({_id:e._id})),await s.a.create({message:t.message,code:e.response.status,method:e.method,path:e.path,param:"GET"===e.method?e.query:e.request.body,username:a.username,stack:t.stack}),401===t.status?(e.status=401,e.body={code:401,msg:"Protected resource, use Authorization header to get"}):(e.status=t.status||500,e.body={code:500,msg:t.message})}}},function(e,t,a){"use strict";var i=a(20),s=a.n(i),n=a(2),o=a(7);t.a=class{constructor(e={}){const t={port:3001,timeInterval:3e4,isAuth:!0,...e};this.wss={},this.timeInterval=t.timeInterval,this.isAuth=t.isAuth,this.port=t.port,this.options=e.options||{}}init(e){this.wss=e?new s.a.Server({server:e,...this.options}):new s.a.Server({port:this.port,...this.options}),this.heartbeat(),this.wss.on("connection",e=>{e.isAlive=!0,e.on("message",t=>this.onMessage(e,t)),e.on("close",()=>this.onClose(e))})}onMessage(e,t){const a=JSON.parse(t);({auth:async()=>{try{const t=await Object(n.c)(a.msg);if(t){e.isAuth=!0,e._id=t._id;const a=await o.a.getTotal(t._id);e.send(JSON.stringify({event:"message",msg:a}))}}catch(t){e.send(JSON.stringify({event:"noauth",msg:"please auth again"}))}},heartbeat:()=>{"pong"===a.message&&(e.isAlive=!0)},message:()=>{!e.isAuth&&this.isAuth||this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e._id&&this.send(t)})}})[a.event]()}onClose(e){}send(e,t){this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e&&a.send(t)})}broadcast(e){this.wss.clients.forEach(t=>{t.readyState===s.a.OPEN&&t.send(e)})}heartbeat(){clearInterval(this.interval),this.interval=setInterval(()=>{this.wss.clients.forEach(e=>{if(!e.isAlive&&e.roomid)return e.terminate();e.isAlive=!1,e.send(JSON.stringify({event:"heartbeat",msg:"ping"}))})},this.timeInterval)}}},function(e,t,a){"use strict";var i=a(4),s=a(2),n=a(8),o=a(6);t.a=async(e,t)=>{const a=e.header.authorization;if(void 0!==a){const i=await Object(s.c)(a);if(i._id){e._id=i._id;if(JSON.parse(await Object(n.a)("admin")).includes(i._id))return e.isAdmin=!0,void await t();e.isAdmin=!1}}const{publicPath:d}=i.a;if(d.some(t=>t.test(e.url)))return void await t();const r=await o.a.getOperations(e);r&&r.includes(e.url)||e.throw(401),await t()}},function(e,t,a){"use strict";var i=a(4),s=a(0),n=a(8);t.a=async()=>{if(i.a.adminEmail&&i.a.adminEmail.length>0){const e=i.a.adminEmail,t=[];for(const a of e){const e=await s.a.findOne({username:a});t.push(e._id)}Object(n.b)("admin",JSON.stringify(t))}}},function(e,t,a){"use strict";var i=a(33),s=a.n(i),n=a(10),o=a.n(n),d=a(34),r=a.n(d),c=a(3),u=a(1),l=a.n(u);const p=new(0,c.a.Schema)({classname:{type:String},name:{type:String},created:{type:Date}});p.pre("save",(function(e){this.created=l()().format("YYYY-MM-DD HH:mm:ss"),e()})),p.statics={getLabel:function(e,t,a,i){let s={};if(void 0!==i.item&&""!==i.item.trim())if("created"===i.search){const e=i.item[0],t=i.item[1];s={created:{$gte:new Date(e),$lt:new Date(t)}}}else"name"===i.search?s[i.search]={$regex:new RegExp(i.item)}:s[i.search]={$in:i.item};return this.find(s).sort({[e]:-1}).skip(t*a).limit(a)},countList:function(e){let t={};if(void 0!==e.item&&""!==e.item.trim())if("created"===e.search){const a=e.item[0],i=e.item[1];t={created:{$gte:new Date(a),$lt:new Date(i)}}}else"name"===e.search?t[e.search]={$regex:new RegExp(e.item)}:t[e.search]={$in:e.item};return this.find(t).countDocuments()}};var m=c.a.model("label",p),g=a(8),f=a(13),y=a(21),h=a.n(y);var w=new class{constructor(){}async getCaptcha(e){const t=e.request.query,a=r.a.create({size:4,ignoreChars:"0o1il",color:!0,noise:Math.floor(5*Math.random()),width:150});t.sid&&Object(g.b)(t.sid,a.text,600),e.body={code:200,data:a.data}}async getLabels(e){const t=await m.find({});e.body={code:200,data:t,msg:"获取文章标签成功"}}async getAdvert(e){const t=await f.a.find({});e.body={code:200,msg:"成功",data:t}}async tmdb(e){const t=e.request.query,a=encodeURI(t.query),i=(await h.a.get("https://api.themoviedb.org/3/search/multi?api_key=b90928d70befc539d0d7949355b20714&language=zh&query="+a)).data.results;e.body={data:i}}async tmdbSimilar(e){const t=e.request.query,a=encodeURI(t.query),i=(await h.a.get(`https://api.themoviedb.org/3/movie/${a}/similar?api_key=b90928d70befc539d0d7949355b20714&language=zh`)).data.results.slice(0,6);i.map(e=>e.overview=""),e.body={data:i}}},b=a(5),v=a(9),_=a.n(v),$=a(11),O=a.n($),S=a(4),q=a(22),x=a.n(q),k=a(0),D=a(2);const M=new(0,c.a.Schema)({tid:{type:String,ref:"post"},uid:{type:String,ref:"users"},title:{type:String},created:{type:Date}});M.pre("save",(function(e){this.created=l()().format("YYYY-MM-DD HH:mm:ss"),e()})),M.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),M.statics={getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};var Y=c.a.model("collects",M),j=a(19),E=a.n(j);const L=c.a.Schema,I=new L({cuid:{type:String,ref:"users"},records:{type:Array}}),R=new L({created:{type:Date,default:""},tid:{type:String,ref:"post"},title:{type:String,default:""}});R.pre("save",(function(e){this.created=l()().format("YYYY-MM-DD HH:mm:ss"),e()})),I.add({records:[R]});var C=c.a.model("records",I),B=a(26),T=a.n(B);var U=new class{async getPostList(e){const t=e.query,a=t.sort?t.sort:"created",i=t.page?parseInt(t.page):0,s=t.limit?parseInt(t.limit):20,n={};void 0!==t.catalog&&""!==t.catalog&&(n.catalog=t.catalog),void 0!==t.isTop&&(n.isTop=t.isTop),void 0!==t.status&&""!==t.status&&(n.status=t.status),void 0!==t.tag&&""!==t.tag&&(n.tags={$elemMatch:{name:t.tag}}),void 0!==t.search&&""!==t.search&&(n.title={$regex:new RegExp(t.search)});const o=await b.a.getList(n,a,i,s),d=await b.a.getListCount(n);e.body={code:200,data:o,msg:"获取文章列表成功",total:d}}async search(e){const t=e.query,a=t.sort?t.sort:"created",i=t.page?parseInt(t.page):0,s=t.limit?parseInt(t.limit):10,n={};if(void 0!==t.search&&""!==t.search){n.title={$regex:new RegExp(t.search)};const o=await b.a.getList(n,a,i,s);if(o.length<1)return void(e.body={code:204,msg:"获取文章列表失败",total:0});const d=`<span style='color: #f94d2a; margin: 0 2px'>${t.search}</span>`,r=new RegExp(t.search,"gi"),c=o.map(e=>(e.content=e.content.replace(/<\/?.+?>/g,""),e.content=e.content.replace(r,d),e.title=e.title.replace(r,d),e)),u=await b.a.getListCount(n);e.body={code:200,data:c,msg:"获取文章列表成功",total:u}}else e.body={code:400,data:[],msg:"获取文章列表失败",total:0}}async getPostListadm(e){const t=e.query;let a=E.a.parse(t);const i=a.page?parseInt(a.page):0,s=a.limit?parseInt(a.limit):20,n=a.option||{};let o=E.a.parse(n);if("name"===o.search){const e=await k.a.getUser(o);o.item=e.map(e=>e._id)}const d=await b.a.getListadm(o,i,s),r=await b.a.countList(o);e.body={code:200,data:d,msg:"获取文章列表成功",total:r}}async getTopList(e){const t=await b.a.getTopList();e.body={code:200,data:t}}async getLinks(e){const t=await f.a.find({type:"links"});e.body={code:200,data:t}}async getTips(e){const t=await f.a.find({type:"tips"});e.body={code:200,data:t}}async getTopWeek(e){const t=await b.a.getTopWeek();e.body={code:200,data:t}}async uploadImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${S.a.uploadPath}/${l()().format("YYYYMMDD")}`;await x()(i);const s=O()(),n=`${i}/${s}.${a}`,o=_.a.createReadStream(t.path),d=_.a.createWriteStream(n),r=`/${l()().format("YYYYMMDD")}/${s}.${a}`;o.pipe(d);const c=await Object(D.c)(e.header.authorization),u=await k.a.findOne({_id:c._id});if("/img/touxiang.jpeg"!==u.pic){let e=u.pic;const t=S.a.uploadPath+e.substr(21);_.a.unlink(t,e=>{e&&console.log(t+"was deleted")})}e.body={code:200,msg:"上传成功!",data:r}}async uploadWangImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${S.a.uploadPath}/${l()().format("YYYYMMDD")}`;await x()(i);const s=O()(),n=`${i}/${s}.${a}`,o=_.a.createReadStream(t.path),d=_.a.createWriteStream(n),r=`/${l()().format("YYYYMMDD")}/${s}.${a}`;o.pipe(d),e.body={code:200,msg:"上传成功!",data:r}}async addPost(e){const{body:t}=e.request;if(t.tags.length>5)return void(e.body={code:403,msg:"标签数量过多!"});const a=t.sid,i=t.code;if(await Object(D.a)(a,i)){const a=await Object(D.c)(e.header.authorization);if((await k.a.findById({_id:a._id})).favs<t.fav)return void(e.body={code:501,msg:"积分不足"});{await k.a.updateOne({_id:a._id},{$inc:{favs:-t.fav}});t.content=T()(t.content);const i=new b.a(t);i.uid=a._id;const s=await i.save();e.body={code:200,msg:"发帖成功",id:s._id}}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async getPostDetail(e){const t=e.query;if(!t.tid)return void(e.body={code:403,msg:"文章标题为空"});const a=await b.a.findByTid(t.tid);if(!a&&void 0!==a&&0!=a)return void(e.body={code:501,msg:"文章不存在"});let i=!1;if(void 0!==e.header.authorization&&""!==e.header.authorization){const s=await Object(D.c)(e.header.authorization),n=await Y.findOne({uid:s._id,tid:t.tid});n&&n.tid&&(i=!0);const o={records:[{tid:t.tid,title:a.title}],cuid:s._id},d=await C.findOne({cuid:s._id});if(d){const e=d.records.filter(e=>e.tid!==t.tid),i=l()().format("YYYY-MM-DD HH:mm:ss");e.unshift({tid:t.tid,title:a.title,created:i});await C.updateOne({cuid:s._id},{records:e})}else{const e=new C(o);await e.save()}}const s=a.toJSON();s.isCollect=i,e.body={code:200,data:s,msg:"查询文章成功"}}async editPost(e){const{body:t}=e.request,a=await Object(D.c)(e.header.authorization),i=await b.a.findOne({_id:t.tid});if(i.uid===a._id&&"0"===i.isEnd){t.content=T()(t.content);const a=await b.a.updateOne({_id:t.tid},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}else e.body={code:401,msg:"修改失败"}}async getPostListByUid(e){const t=e.query,a=await Object(D.c)(e.header.authorization),i=await b.a.getListByUid(a._id,t.page,10),s=await b.a.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}async deletePostByTid(e){const t=e.query,a=await Object(D.c)(e.header.authorization);if((await b.a.findOne({uid:a._id,_id:t.tid})).uid===a._id){const a=await b.a.deleteOne({_id:t.tid}),i=await Y.deleteOne({tid:t.tid});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}else e.body={code:500,msg:"删除失败,无权限"}}async getColleByUid(e){const t=e.query,a=await Object(D.c)(e.header.authorization),i=await Y.getListByUid(a._id,t.page,10),s=await Y.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}async deletepost(e){const t=e.query,a=await b.a.deleteOne({_id:t.tid}),i=await Y.deleteOne({tid:t.tid});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async deleteposts(e){const{body:t}=e.request,a=await b.a.deleteMany({_id:{$in:t}}),i=await Y.deleteMany({tid:{$in:t}});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async batchUpdatePosts(e){const{body:t}=e.request,a=await b.a.updateMany({_id:{$in:t.ids}},{$set:{...t.set}});1===a.ok&&(e.body={code:200,data:a})}async getLabel(e){const t=e.query,a=E.a.parse(t),i=a.sort?a.sort:"created",s=a.page?parseInt(a.page):0,n=a.limit?parseInt(a.limit):10,o=a.option||{},d=await m.getLabel(i,s,n,o),r=await m.countList(o);e.body={code:200,data:d,msg:"获取文章列表成功",total:r}}async addLabel(e){const{body:t}=e.request,a=new m(t),i=await a.save();e.body={code:200,data:i,msg:"新增成功"}}async deleteLabel(e){const t=e.query,a=await m.deleteOne({_id:t._id}),i=await Y.deleteOne({tid:t._id});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}async editLabel(e){const{body:t}=e.request,a=await m.updateOne({_id:t._id},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}async getHistory(e){const t=e.query,a=e.header.authorization;if(void 0!==a){const i=await Object(D.c)(a),s=await C.findOne({cuid:i._id}),n=s.records.length;s.records=s.records.slice(t.page,t.page+10),e.body={code:200,data:s,msg:"查询成功",total:n}}else e.body={code:400,msg:"查询失败"}}async deleteHistory(e){const t=e.query,a=e.header.authorization;if(void 0!==a){const i=await Object(D.c)(a),s=await C.findOne({cuid:i._id}),n="";s.records.forEach((e,a,i)=>{e._id===t._id&&(n=a)}),s.records.splice(n,1);const o=await C.updateOne({cuid:i._id},{records:s.records});e.body={code:200,data:o,msg:"删除成功"}}else e.body={code:400,msg:"删除失败"}}async searchDefault(e){const t=await b.a.aggregate([{$sample:{size:1}},{$project:{_id:1,title:1}}]);e.body={code:200,data:t[0],msg:"查询成功"}}async randomArticle(e){const t=await b.a.aggregate([{$sample:{size:10}},{$project:{_id:1,title:1}}]);e.body={code:200,data:t,msg:"查询成功"}}},A=a(15),H=a(36),P=a.n(H);var z=async function(e){let t=P.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"2116615470@qq.com",pass:"hpxfsublqlnmecfe"}}),a=`${S.a.baseUrl}/#${"email"===e.type?"/confirm":"/reset"}?`+E.a.stringify(e.data);return(await t.sendMail({from:'"认证邮件" <2116615470@qq.com>',to:e.email,subject:""!==e.user&&"email"!==e.type?`你好${e.user}！确认修改密码链接`:"《杰斯社区》确认修改邮箱链接",text:`您在《杰斯社区》中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Fly社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user},重置链接有效时间30分钟，请在${e.expire}之前重置您的密码：</div>\n          <a href="${a}" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">立即重置</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId},N=a(14),J=a.n(N),W=a(12),F=a.n(W),V=a(7);var K=new class{async userSign(e){const t=await Object(D.c)(e.header.authorization),a=await A.a.findByUid(t._id),i=await k.a.findByID(t._id);let s={},n="";if(null!==a){if(l()(a.created).format("YYYY-MM-DD")===l()().format("YYYY-MM-DD"))return void(e.body={code:500,msg:"已签到",favs:i.favs,count:i.count});{let e=i.count,o=0;l()(a.created).format("YYYY-MM-DD")===l()().subtract(1,"days").format("YYYY-MM-DD")?(e+=1,o=e<=10?5:e>10&&e<=20?10:e>20&&e<=40?15:20,await k.a.updateOne({_id:t._id},{$inc:{count:1,favs:o}}),n={favs:i.favs+o,count:i.count+1}):(await k.a.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),n={favs:i.favs+o,count:1},o=5),s=new A.a({uid:t._id,favs:o}),await s.save()}}else await k.a.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),s=new A.a({uid:t._id,favs:5}),await s.save(),n={favs:i.favs+5,count:1};e.body={code:200,msg:"cg",...n}}async updateUserInfo(e){const{body:t}=e.request;if(t.regmark.length>20)return void(e.body={code:500,msg:"更新失败,标签名过长!"});const a=await Object(D.c)(e.header.authorization),i=await k.a.findOne({_id:a._id});let s="";if(t.username!==i.username&&!t.pic){const n=await k.a.findOne({username:a.username});if(n&&n.password)return void(e.body={code:501,msg:"用户名已存在/邮箱已被注册"});const o=O()();Object(g.b)(o,J.a.sign({_id:a._id},S.a.JWT_SERCET,{expiresIn:"30m"}));await z({type:"email",data:{key:o,username:t.username},code:"",expire:l()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:i.username,user:i.name});s="基本信息已修改成功,用户名修改请到发送的邮件修改"}["username","password","mobile"].map(e=>{delete t[e]});const n=await k.a.updateOne({_id:a._id},t);1===n.n&&1===n.ok?e.body={code:200,msg:""===s?"更新成功":s}:e.body={code:500,msg:"更新失败"}}async updateUsername(e){const t=e.query;if(t.key){const a=await Object(g.a)(t.key),i=Object(D.c)("Bearer "+a);await k.a.updateOne({_id:i._id},{username:t.username}),e.body={code:200,msg:"更新用户名成功!"}}}async updateUserpass(e){const t=e.query;if(t.key){const a=await Object(g.a)(t.key),i=Object(D.c)("Bearer "+a),s=await F.a.hash(t.password,5);await k.a.updateOne({_id:i._id},{password:s}),e.body={code:200,msg:"更新密码成功!"}}}async changepw(e){const{body:t}=e.request,a=await Object(D.c)(e.header.authorization),i=await k.a.findOne({_id:a._id});if(await F.a.compare(t.oldpwd,i.password)){const i=await F.a.hash(t.password,5);await k.a.updateOne({_id:a._id},{$set:{password:i}}),e.body={code:200,msg:"更改密码成功!"}}else e.body={code:500,msg:"您输入的原密码不正确!"}}async collect(e){}async setCollect(e){const t=e.query,a=await Object(D.c)(e.header.authorization);if(parseInt(t.isCollect))await Y.deleteOne({uid:a._id,tid:t.tid}),e.body={code:200,msg:"取消收藏成功"};else{const i=new Y({uid:a._id,tid:t.tid,title:t.title});(await i.save()).uid?e.body={code:200,msg:"收藏成功"}:e.body={code:400,msg:"收藏失败"}}}async getmsg(e){const t=e.query,a=t.page?t.page:0,i=await Object(D.c)(e.header.authorization),s=await V.a.getMsgList(i._id,a,6);e.body={code:200,data:s}}async getinfo(e){const t=await Object(D.c)(e.header.authorization),a=(await k.a.findOne({_id:t._id})).toJSON();["password","username"].map(e=>{delete a[e]}),e.body={code:200,data:a}}async getUserList(e){const{body:t}=e.request,a=t.page?parseInt(t.page):0,i=t.limit?parseInt(t.limit):10,s=t.option||{},n=await k.a.getList(a,i,s),o=await k.a.getListCount(s);e.body={code:200,data:n,total:o}}async editUser(e){const{body:t}=e.request;if(await k.a.findOne({_id:t._id})){t.password?t.password=await F.a.hash(t.password,5):delete t.password;const a=await k.a.updateOne({_id:t._id},t);1===a.n&&1===a.ok?e.body={code:200,msg:"更新成功"}:e.body={code:500,msg:"更新失败"}}}async batchUpdateUser(e){const{body:t}=e.request,a=await k.a.updateMany({_id:{$in:t.ids}},{$set:{...t.set}});1===a.ok&&(e.body={code:200,data:a})}async deleteUser(e){const{body:t}=e.request;1===(await k.a.deleteMany({_id:{$in:t}})).ok?e.body={code:200,msg:"删除成功!"}:e.body={code:500,msg:"删除失败!"}}async checkName(e){const t=e.query,a=await k.a.findOne({name:t.name});e.body=a?{code:500,msg:"昵称重复!"}:{code:200,msg:"昵称有效!"}}async checkUsername(e){const t=e.query,a=await k.a.findOne({username:t.username});e.body=a?{code:500,msg:"邮箱重复!"}:{code:200,msg:"邮箱有效!"}}async addUser(e){const{body:t}=e.request;t.password=await F.a.hash(t.password,5);const a=new k.a(t),i=await a.save();e.body={code:200,msg:"新增用户成功",data:i}}async getInfo(e){const t=e.query,a=await k.a.findByID(t._id);e.body=a?{code:200,msg:"查询成功",data:a}:{code:400,msg:"查询失败"}}};const G=new(0,c.a.Schema)({uid:{type:String},cid:{type:String},created:{type:Date}});G.pre("save",(function(e){this.created=l()().format("YYYY-MM-DD HH:mm:ss"),e()})),G.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),G.statics={findByCid:function(e){return this.find({cid:e})}};var Q=c.a.model("Comments_Hands",G);var X=new class{async getComments(e){const t=e.query,a=t.tid,i=t.page?t.page:0;let s=await V.a.getCommentsList(a,i,10);const n=await V.a.queryCont(a);let o={};if(void 0!==e.header.authorization&&(o=await Object(D.c)(e.header.authorization)),void 0!==o){s=s.map(e=>e.toJSON());for(let e=0;e<s.length;e++){let t=s[e];t.handed="0";const a=await Q.findOne({cid:t._id,uid:o._id});a&&a.cid&&a.uid===o._id&&(t.handed="1")}}1===(await b.a.updateOne({_id:t.tid},{$inc:{reads:1}})).ok?e.body={code:200,total:n,data:s,msg:"查询成功"}:e.body={code:500,msg:"查询失败"}}async addComment(e){if(await(async e=>{let t=!0;const a=await Object(D.c)(e.header.authorization);if(void 0===a._id)return t;return"0"===(await k.a.findByID(a._id)).status&&(t=!1),t})(e))return void(e.body={code:500,msg:"用户已被禁言!"});const{body:t}=e.request,a=await b.a.findOne({_id:t.tid});if(1===a.status)return void(e.body={code:500,msg:"评论失败,此贴禁止评论"});const i=new V.a(t),s=await Object(D.c)(e.header.authorization);i.cuid=s._id,i.uid=a.uid;const n=await i.save(),o=await V.a.getTotal(a.uid);global.ws.send(a.uid,JSON.stringify({event:"message",msg:o}));1===(await b.a.updateOne({_id:t.tid},{$inc:{answer:1}})).ok?e.body={code:200,data:n,msg:"评论成功"}:e.body={code:500,data:n,msg:"评论失败"}}async setBest(e){const t=await Object(D.c)(e.header.authorization);if(void 0===t&&""!==t._id)return void(e.body={code:401,msg:"用户未登录,或者未授权"});const a=e.query,i=await b.a.findOne({_id:a.tid}),s=await V.a.findByCid(a.cid);if(s.cuid!==t._id)if(i.uid===t._id&&"0"===i.isEnd){const t=await b.a.updateOne({_id:a.tid},{$set:{isEnd:"1"}}),n=await V.a.updateOne({_id:a.cid},{$set:{isBest:"1"}});if(1===t.ok&&1===n.ok){1===(await k.a.updateOne({_id:s.cuid},{$inc:{favs:parseInt(i.fav)}})).ok?e.body={code:200,msg:"设置成功"}:e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"帖子已结贴或重复设置"};else e.body={code:500,msg:"不能给自己的评论设置最佳"}}async setHands(e){const t=await Object(D.c)(e.header.authorization),a=e.query;if((await Q.find({cid:a.cid,uid:t._id})).length>0)return void(e.body={code:500,msg:"重复点赞"});const i=new Q({cid:a.cid,uid:t._id});await i.save();1===(await V.a.updateOne({_id:a.cid},{$inc:{hands:1}})).ok?e.body={code:200,msg:"点赞成功"}:e.body={code:500,msg:"点赞失败"}}};const Z=new o.a;Z.prefix("/public"),Z.get("/list",U.getPostList),Z.get("/searchPost",U.search),Z.get("/adlist",U.getPostListadm),Z.get("/topList",U.getTopList),Z.get("/getCaptcha",w.getCaptcha),Z.get("/tips",U.getTips),Z.get("/links",U.getLinks),Z.get("/topWeek",U.getTopWeek),Z.get("/setEmail",K.updateUsername),Z.get("/setPass",K.updateUserpass),Z.get("/content/detail",U.getPostDetail),Z.get("/comments",X.getComments),Z.get("/getinfo",K.getinfo),Z.get("/getlabel",U.getLabel),Z.get("/getLabels",w.getLabels),Z.get("/getAdvert",w.getAdvert),Z.get("/getInfos",K.getInfo),Z.get("/searchDefault",U.searchDefault),Z.get("/randomArticle",U.randomArticle),Z.get("/tmdb",w.tmdb),Z.get("/tmdbSimilar",w.tmdbSimilar);var ee=Z,te=a(37),ae=a.n(te),ie=a(24),se=a.n(ie);var ne=new class{async forget(e){const{body:t}=e.request,a=t.sid,i=t.code,s=await Object(D.a)(a,i),n=await k.a.findOne({username:t.username});if(s)if(n){const a=O()();Object(g.b)(a,J.a.sign({_id:n._id},S.a.JWT_SERCET,{expiresIn:"30m"}));await z({type:"forget",code:"",data:{key:a,username:t.username},expire:l()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:n.name});e.body={code:200,msg:"邮件发送成功,请查收更改密码"}}else e.body={code:500,msg:"用户名不存在"};else e.body={code:401,msg:"图片验证码不正确或已失效"}}async login(e){const{body:t}=e.request;let a=t.sid,i=t.code;if(await Object(D.a)(a,i)){let a=!1,i=await k.a.findOne({username:t.username});if(await F.a.compare(t.password,i.password)&&(a=!0),a){const t=i.toJSON();["password","username"].map(e=>{delete t[e]});const a=J.a.sign({_id:t._id},S.a.JWT_SERCET,{expiresIn:"7d"}),s=await A.a.findByUid(t._id);null!==s&&l()(s.created).format("YYYY-MM-DD")===l()().format("YYYY-MM-DD")?t.isSign=!0:t.isSign=!1,e.body={code:200,token:a,data:t}}else e.body={code:404,msg:"用户名/密码验证失败"}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async reg(e){let{body:t}=e.request,a=t.sid,i=t.code,s={},n=!0;if(await Object(D.a)(a,i)){let a=await k.a.findOne({username:t.username});null!==a&&void 0!==a.username&&(s.username=["此邮箱已被注册,可以通过忘记密码找回"],n=!1);let i=await k.a.findOne({name:t.name});if(null!==i&&void 0!==i.name&&(s.name=["此昵称已被注册"],n=!1),n){t.password=await F.a.hash(t.password,5);let a=new k.a({username:t.username,name:t.name,password:t.password,created:l()().format("YYYY-MM-DD HH:mm:ss")}),i=await a.save();return void(e.body={code:200,data:i,msg:"注册成功"})}}else s.code=["图片验证码不正确或已失效"];e.body={code:500,msg:s}}async wxLogin(e){const{body:t}=e.request;let a="";if(t.code){const i=await(async(e,t)=>{const a=await h.a.get(`https://api.weixin.qq.com/sns/jscode2session?appid=${S.a.AppId}&secret=${S.a.AppSecret}&js_code=${e}&grant_type=authorization_code`);if(200===a.status&&a.data.session_key){const e=a.data.session_key,{rawData:i,signature:s,encryptedData:n,iv:o}=t,d=se.a.createHash("sha1");if(d.update(i),d.update(e),d.digest("hex")!==s)return Promise.reject(new Error({code:500,msg:"签名校验失败,去检查"}));return new ae.a(S.a.AppId,e).decryptData(n,o)}throw new Error(a.data&&a.data.errmsg?a.data.errmsg:"请求微信接口失败")})(t.code,t.user);a=await k.a.findOrCreatedByOpenData(i),e.body={code:200,msg:"成功",token:Object(D.b)({_id:a._id}),data:a}}else e.body={code:500,msg:"code不存在"}}};const oe=new o.a;oe.prefix("/login"),oe.post("/forget",ne.forget),oe.post("/login",ne.login),oe.post("/reg",ne.reg),oe.post("/wxlogin",ne.wxLogin);var de=oe;const re=new o.a;re.prefix("/user"),re.get("/fav",K.userSign),re.post("/basic",K.updateUserInfo),re.post("/changepw",K.changepw),re.get("/Collect",K.collect),re.get("/setCollect",K.setCollect),re.get("/post",U.getPostListByUid),re.get("/deletePost",U.deletePostByTid),re.get("/getColleList",U.getColleByUid),re.get("/getmsg",K.getmsg),re.post("/getuserlist",K.getUserList),re.post("/edituser",K.editUser),re.post("/batchupdate",K.batchUpdateUser),re.post("/deleteuser",K.deleteUser),re.get("/checkusername",K.checkUsername),re.get("/checkname",K.checkName),re.post("/addUser",K.addUser);var ce=re;const ue=new o.a;ue.prefix("/content"),ue.post("/upload",U.uploadImg),ue.post("/add",U.addPost),ue.post("/uploadWang",U.uploadWangImg),ue.get("/deletepost",U.deletepost),ue.post("/deleteposts",U.deleteposts),ue.post("/editpostbyid",U.editPost),ue.post("/batchposts",U.batchUpdatePosts),ue.post("/addLabel",U.addLabel),ue.post("/editLabel",U.editLabel),ue.get("/deletelabel",U.deleteLabel),ue.get("/getHistory",U.getHistory),ue.get("/deleteHistory",U.deleteHistory);var le=ue;const pe=new o.a;pe.prefix("/comments"),pe.post("/reply",X.addComment),pe.get("/accept",X.setBest),pe.get("/sethands",X.setHands);var me=pe,ge=a(6);const fe=new o.a;fe.prefix("/admin"),fe.post("/addMenu",ge.a.addMenu),fe.get("/deleteMenu",ge.a.deleteMenu),fe.post("/updataMenu",ge.a.updataMenu),fe.get("/getMenus",ge.a.getMenus),fe.post("/addRoles",ge.a.addRoles),fe.get("/deleteRoles",ge.a.deleteRoles),fe.post("/updataRoles",ge.a.updataRoles),fe.get("/getRoles",ge.a.getRoles),fe.get("/getRolesName",ge.a.getRolesName),fe.post("/getcomment",ge.a.getcomment),fe.get("/deleteComment",ge.a.deleteComment),fe.post("/editComment",ge.a.editComment),fe.post("/batchEditComment",ge.a.batchEditComment),fe.post("/batchDeleteComment",ge.a.batchDeleteComment),fe.get("/getroutes",ge.a.getRoutes),fe.get("/getStats",ge.a.getStats),fe.get("/getLogs",ge.a.getLogs),fe.post("/deleteLogs",ge.a.deleteLogs),fe.post("/uploadImg",ge.a.uploadImg),fe.post("/uploadAdvert",ge.a.uploadAdvert),fe.post("/deleteAdvert",ge.a.deleteAdvert);var ye=fe;t.a=s()(ee,de,ce,le,me,ye)},function(e,t,a){"use strict";a.r(t),function(e){var i=a(29),s=a.n(i),n=a(30),o=a.n(n),d=a(16),r=a.n(d),c=a(31),u=a.n(c),l=a(32),p=a.n(l),m=a(47),g=a(38),f=a.n(g),y=a(39),h=a.n(y),w=a(40),b=a.n(w),v=a(41),_=a.n(v),$=a(42),O=a.n($),S=a(4),q=a(43),x=a(44),k=a(45),D=a(46),M=a(17),Y=a(28),j=a.n(Y),E=a(9),L=a.n(E);const I=new s.a,R={key:L.a.readFileSync(r.a.join(e,"./cert/7396045_www.toped.top.key"),"utf8"),cert:L.a.readFileSync(r.a.join(e,"./cert/7396045_www.toped.top.pem"),"utf8")},C=j.a.createServer(R,I.callback());C.listen(444);let B="";{const t={key:L.a.readFileSync(r.a.join(e,"./cert/7403365_www.toped.top.key"),"utf8"),cert:L.a.readFileSync(r.a.join(e,"./cert/7403365_www.toped.top.pem"),"utf8")};B=j.a.createServer(t,I.callback()).listen(3001)}const T=new x.a;T.init(B),global.ws=T;const U=o()({secret:S.a.JWT_SERCET}).unless({path:[/^\/public/,/\/login/]}),A=_()([f()({multipart:!0,formidable:{keepExtensions:!0,maxFieldsSize:5242880},onError:e=>{console.log(e)}}),p()(r.a.join(e,"../public")),b()(),h()({pretty:!1,param:"pretty"}),u()(),U,k.a,q.a,M.a.koaLogger(M.a.getLogger("access"),{level:"auto"})]);I.use(O()()),I.use(A),I.use(Object(m.a)()),I.listen(3e3,()=>{console.log("app is runing at 3000"),Object(D.a)()}),t.default=C}.call(this,"src")},function(e,t){e.exports=require("dayjs/plugin/weekday")}]);