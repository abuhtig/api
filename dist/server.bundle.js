!function(e){var t={};function a(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)a.d(i,s,function(t){return e[t]}.bind(null,s));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=33)}([function(e,t){e.exports=require("dayjs")},function(e,t,a){"use strict";a.d(t,"a",(function(){return r})),a.d(t,"b",(function(){return d}));var i=a(6),s=a(2),o=a(8),n=a.n(o);const d=e=>n.a.verify(e.split(" ")[1],s.a.JWT_SERCET),r=async(e,t)=>{const a=await Object(i.a)(e);return null!=a&&a.toLowerCase()==t.toLowerCase()}},function(e,t,a){"use strict";a(13);t.a={DB_URL:"mongodb://test:password@120.48.21.232:27017/testdb",REDIS:{host:"120.48.21.232",port:6379,password:"123456"},JWT_SERCET:"F&l8mWkDt$9a1lQBuaej9oJ2T35@u7ur69szx6smKJINzMbUYjHxiFd*1KxpJ8zH",baseUrl:"http://120.48.21.232:80",uploadPath:"/app/public"}},function(e,t,a){"use strict";var i=a(10),s=a.n(i),o=a(2);s.a.set("useCreateIndex",!0),s.a.connect(o.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),s.a.connection.on("connected",()=>{console.log("Mongoose connection open to "+o.a.DB_URL)}),s.a.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),s.a.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")}),t.a=s.a},function(e,t,a){"use strict";var i=a(3),s=a(0),o=a.n(s);const n=new(0,i.a.Schema)({tid:{type:String,ref:"post"},cuid:{type:String,ref:"users"},content:{type:String},created:{type:Date},hands:{type:Number,default:0},status:{type:String,default:"1"},isRead:{type:String,default:"0"},isBest:{type:String,default:"0"}});n.pre("save",(function(e){this.created=o()().format("YYYY-MM-DD HH:mm:ss"),e()})),n.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),n.statics={findByTid:function(e){return this.find({tid:e})},findByCid:function(e){return this.findOne({_id:e})},getCommentsList:function(e,t,a){return this.find({tid:e}).populate({path:"cuid",select:"_id name pic isVip",match:{status:{$eq:"0"}}}).populate({path:"tid",select:"_id uid status"}).skip(t*a).limit(a)},queryCont:function(e){return this.find({tid:e}).countDocuments()},getTotal:function(e){return this.find({cuid:e,isRead:"0",status:"1"}).countDocuments()},getMsgList:function(e,t,a){return this.aggregate([{$lookup:{from:"posts",let:{pid:{$toObjectId:"$tid"}},pipeline:[{$match:{$expr:{$eq:["$_id","$$pid"]}}},{$project:{_id:1,uid:1,title:1}}],as:"post"}},{$replaceRoot:{newRoot:{$mergeObjects:[{$arrayElemAt:["$post",0]},"$$ROOT"]}}},{$addFields:{userId:{$toObjectId:"$uid"}}},{$lookup:{from:"users",localField:"userId",foreignField:"_id",as:"tuid"}},{$unwind:"$tuid"},{$addFields:{fuserId:{$toObjectId:"$cuid"}}},{$lookup:{from:"users",localField:"fuserId",foreignField:"_id",as:"fuid"}},{$unwind:"$fuid"},{$project:{post:0,tuid:{username:0,password:0},fuid:{username:0,password:0},userId:0,tid:0,cuid:0}},{$match:{uid:e,status:"1",isRead:"0"}}]).skip(t*a).limit(a)}};const d=i.a.model("comments",n);t.a=d},function(e,t){e.exports=require("koa-router")},function(e,t,a){"use strict";a.d(t,"b",(function(){return c})),a.d(t,"a",(function(){return u}));var i=a(14),s=a.n(i),o=a(22),n=a(2);const d={host:n.a.REDIS.host,port:n.a.REDIS.port,password:n.a.REDIS.password,detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},r=Object(o.promisifyAll)(s.a.createClient(d));r.on("error",e=>{console.log("Redis Client Error:"+e)});const c=(e,t,a)=>{void 0!==t&&null!=t&&""!==t&&("string"==typeof t?void 0!==a?r.set(e,t,"EX",a):r.set(e,t):"object"==typeof t&&Object.keys(t).forEach(a=>{r.hset(e,a,t[a],s.a.print)}))},u=e=>r.getAsync(e)},function(e,t){e.exports=require("uuid/v4")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("make-dir")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-combine-routers")},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("qs")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-compose")},function(e,t){e.exports=require("koa-compress")},function(e,t,a){"use strict";t.a=(e,t)=>t().catch(t=>{401==t.status?(e.status=401,e.body={code:401,msg:"Protected resource, use Authorization header to get"}):(e.status=t.status||500,e.body={code:500,msg:t.message})})},function(e,t,a){"use strict";var i=a(12),s=a.n(i),o=a(1),n=a(4);t.a=class{constructor(e={}){const t={port:3001,timeInterval:3e4,isAuth:!0,...e};this.wss={},this.timeInterval=t.timeInterval,this.isAuth=t.isAuth,this.port=t.port,this.options=e.options||{}}init(){this.wss=new s.a.Server({port:this.port,...this.options}),this.heartbeat(),this.wss.on("connection",e=>{e.isAlive=!0,e.on("message",t=>this.onMessage(e,t)),e.on("close",()=>this.onClose(e))})}onMessage(e,t){const a=JSON.parse(t);({auth:async()=>{try{const t=await Object(o.b)(a.msg);if(t){e.isAuth=!0,e._id=t._id;const a=await n.a.getTotal(t._id);e.send(JSON.stringify({event:"message",msg:a}))}}catch(t){e.send(JSON.stringify({event:"noauth",msg:"please auth again"}))}},heartbeat:()=>{"pong"===a.message&&(e.isAlive=!0)},message:()=>{!e.isAuth&&this.isAuth||this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e._id&&this.send(t)})}})[a.event]()}onClose(e){}send(e,t){this.wss.clients.forEach(a=>{a.readyState===s.a.OPEN&&a._id===e&&a.send(t)})}broadcast(e){this.wss.clients.forEach(t=>{t.readyState===s.a.OPEN&&t.send(e)})}heartbeat(){clearInterval(this.interval),this.interval=setInterval(()=>{this.wss.clients.forEach(e=>{if(!e.isAlive&&e.roomid)return e.terminate();e.isAlive=!1,e.send(JSON.stringify({event:"heartbeat",msg:"ping"}))})},this.timeInterval)}}},function(e,t,a){"use strict";var i=a(20),s=a.n(i),o=a(5),n=a.n(o),d=a(21),r=a.n(d),c=a(6);var u=new class{constructor(){}async getCaptcha(e){const t=e.request.query;console.log(t.sid);const a=r.a.create({size:4,ignoreChars:"0o1il",color:!0,noise:Math.floor(5*Math.random()),width:150});Object(c.b)(t.sid,a.text,600),e.body={code:200,data:a.data}}},p=a(3),l=a(0),f=a.n(l);const m=new(0,p.a.Schema)({title:{type:String,default:""},link:{type:String,default:""},type:{type:String,default:"link"},created:{type:Date},isTop:{type:String,default:""},sort:{type:String,default:""}});m.pre("save",(function(e){this.created=f()(),e()}));var g=p.a.model("links",m);const y=new(0,p.a.Schema)({uid:{type:String,ref:"users"},catalog:{type:String},title:{type:String},content:{type:String},created:{type:Date},fav:{type:String},isEnd:{type:String,default:"0"},reads:{type:Number,default:0},answer:{type:Number,default:0},status:{type:String,default:"0"},isTop:{type:String,default:"0"},sort:{type:String,default:100},tags:{type:Array}});y.pre("save",(function(e){this.created=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),y.statics={getList:function(e,t,a,i){return this.find(e).sort({[t]:-1}).skip(a*i).limit(i).populate({path:"uid",select:"name isVip pic"})},getTopWeek:function(){return this.find({created:{$gte:f()().subtract(7,"days")}},{answer:1,title:1}).sort({answer:-1}).limit(15)},findByTid:function(e){return this.findOne({_id:e}).populate({path:"uid",select:"name pic isVip _id"})},getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};var b=p.a.model("post",y),h=a(11),w=a.n(h),v=a(7),_=a.n(v),O=a(2),Y=a(15),S=a.n(Y);const $=new(0,p.a.Schema)({username:{type:String,index:{unique:!0},sparse:!0},password:{type:String},name:{type:String},created:{type:Date},updated:{type:Date},favs:{type:Number,default:0},gender:{type:String},roles:{type:Array,default:["user"]},pic:{type:String,default:"/img/touxiang.jpeg"},mobile:{type:String,match:/^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d{8}$/},status:{type:String,default:"0"},regmark:{type:String,default:""},location:{type:String,default:""},isVip:{type:String,default:"0"},count:{type:Number,default:"0"}});$.pre("save",(function(e){this.created=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),$.pre("update",(function(e){this.update=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),$.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("Error: Monngoose has a duplicate key.")):a(e)})),$.statics={findByID:function(e){return this.findOne({_id:e},{password:0,username:0,mobile:0})}};var x=p.a.model("users",$),D=a(1);const k=new(0,p.a.Schema)({tid:{type:String,ref:"post"},uid:{type:String,ref:"users"},title:{type:String},created:{type:Date}});k.pre("save",(function(e){this.created=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),k.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),k.statics={getListByUid:function(e,t,a){return this.find({uid:e}).skip(t*a).limit(a).sort({created:-1})},countByUid:function(e){return this.find({uid:e}).countDocuments()}};var q=p.a.model("collects",k);var M=new class{async getPostList(e){const t=e.query,a=t.sort?t.sort:"created",i=t.page?parseInt(t.page):0,s=t.limit?parseInt(t.limit):20,o={};void 0!==t.catalog&&""!==t.catalog&&(o.catalog=t.catalog),void 0!==t.isTop&&(o.isTop=t.isTop),void 0!==t.status&&""!==t.status&&(o.status=t.status),void 0!==t.tag&&""!==t.tag&&(o.tags={$elemMatch:{name:t.tag}});const n=await b.getList(o,a,i,s);e.body={code:200,data:n,msg:"获取文章列表成功"}}async getLinks(e){const t=await g.find({type:"links"});e.body={code:200,data:t}}async getTips(e){const t=await g.find({type:"tips"});e.body={code:200,data:t}}async getTopWeek(e){const t=await b.getTopWeek();e.body={code:200,data:t}}async uploadImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${O.a.uploadPath}/${f()().format("YYYYMMDD")}`;await S()(i);const s=_()(),o=`${i}/${s}.${a}`,n=w.a.createReadStream(t.path),d=w.a.createWriteStream(o),r=`/${f()().format("YYYYMMDD")}/${s}.${a}`;n.pipe(d);const c=await Object(D.b)(e.header.authorization),u=await x.findOne({_id:c._id});if("/img/touxiang.jpeg"!==u.pic){let e=u.pic;const t=O.a.uploadPath+e.substr(21);w.a.unlink(t,e=>{if(e)throw e;console.log(t+"was deleted")})}e.body={code:200,msg:"上传成功!",data:r}}async uploadWangImg(e){const t=e.request.files.file,a=t.name.split(".").pop(),i=`${O.a.uploadPath}/${f()().format("YYYYMMDD")}`;await S()(i);const s=_()(),o=`${i}/${s}.${a}`,n=w.a.createReadStream(t.path),d=w.a.createWriteStream(o),r=`/${f()().format("YYYYMMDD")}/${s}.${a}`;n.pipe(d),e.body={code:200,msg:"上传成功!",data:r}}async addPost(e){const{body:t}=e.request,a=t.sid,i=t.code;if(await Object(D.a)(a,i)){const a=await Object(D.b)(e.header.authorization);if((await x.findById({_id:a._id})).favs<t.fav)return void(e.body={code:501,msg:"积分不足"});{await x.updateOne({_id:a._id},{$inc:{favs:-t.fav}});const i=new b(t);i.uid=a._id;await i.save();e.body={code:200,msg:"发帖成功"}}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async getPostDetail(e){const t=e.query;if(!t.tid)return void(e.body={code:500,msg:"文章标题为空"});const a=await b.findByTid(t.tid);if(!a&&void 0!==a&&0!=a)return void(e.body={code:501,msg:"文章不存在"});let i=!1;if(void 0!==e.header.authorization&&""!==e.header.authorization){const a=await Object(D.b)(e.header.authorization),s=await q.findOne({uid:a._id,tid:t.tid});s&&s.tid&&(i=!0)}const s=a.toJSON();s.isCollect=i,e.body={code:200,data:s,msg:"查询文章成功"}}async editPost(e){const{body:t}=e.request,a=await Object(D.b)(e.header.authorization),i=await b.findOne({_id:t.tid});if(i.uid===a._id&&"0"===i.isEnd){const a=await b.updateOne({_id:t.tid},t);1===a.ok?e.body={code:200,data:a,msg:"更新帖子成功"}:e.body={code:500,data:a,msg:"更新帖子失败"}}else e.body={code:401,msg:"修改失败"}}async getPostListByUid(e){const t=e.query,a=await Object(D.b)(e.header.authorization),i=await b.getListByUid(a._id,t.page,10),s=await b.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}async deletePostByTid(e){const t=e.query,a=await Object(D.b)(e.header.authorization);if((await b.findOne({uid:a._id,_id:t.tid})).uid===a._id){const a=await b.deleteOne({_id:t.tid}),i=await q.deleteOne({tid:t.tid});1===a.ok&&1===i.ok?e.body={code:200,msg:"删除成功"}:e.body={code:500,msg:"删除失败"}}else e.body={code:500,msg:"删除失败,无权限"}}async getColleByUid(e){const t=e.query,a=await Object(D.b)(e.header.authorization),i=await q.getListByUid(a._id,t.page,10),s=await q.countByUid(a._id);i.length>0?e.body={code:200,msg:"请求成功",data:i,total:s}:e.body={code:500,msg:"请求失败"}}};const j=new(0,p.a.Schema)({uid:{type:String,ref:"users"},created:{type:Date},favs:{type:Number}});j.pre("save",(function(e){this.created=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),j.statics={findByUid:function(e){return this.findOne({uid:e}).sort({created:-1})}};var E=p.a.model("sign_record",j),T=a(23),C=a.n(T),I=a(24),B=a.n(I);var U=async function(e){let t=C.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"2116615470@qq.com",pass:"hpxfsublqlnmecfe"}}),a=`${O.a.baseUrl}/#${"email"===e.type?"/confirm":"/reset"}?`+B.a.stringify(e.data);return(await t.sendMail({from:'"认证邮件" <2116615470@qq.com>',to:e.email,subject:""!==e.user&&"email"!==e.type?`你好${e.user}！确认修改密码链接`:"《Fly社区》确认修改邮箱链接",text:`您在《Fly社区》中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Fly社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user},重置链接有效时间30分钟，请在${e.expire}之前重置您的密码：</div>\n          <a href="${a}" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">立即重置</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId},P=a(8),z=a.n(P),H=a(9),R=a.n(H),L=a(4);var N=new class{async userSign(e){const t=await Object(D.b)(e.header.authorization),a=await E.findByUid(t._id),i=await x.findByID(t._id);let s={},o="";if(null!==a){if(f()(a.created).format("YYYY-MM-DD")===f()().format("YYYY-MM-DD"))return void(e.body={code:500,msg:"已签到",favs:i.favs,count:i.count});{let e=i.count,n=0;f()(a.created).format("YYYY-MM-DD")===f()().subtract(1,"days").format("YYYY-MM-DD")?(e+=1,n=e<=10?5:e>10&&e<=20?10:e>20&&e<=40?15:20,await x.updateOne({_id:t._id},{$inc:{count:1,favs:n}}),o={favs:i.favs+n,count:i.count+1}):(await x.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),o={favs:i.favs+n,count:1},n=5),s=new E({uid:t._id,favs:n}),await s.save()}}else await x.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),s=new E({uid:t._id,favs:5}),await s.save(),o={favs:i.favs+5,count:1};e.body={code:200,msg:"cg",...o}}async updateUserInfo(e){const{body:t}=e.request,a=await Object(D.b)(e.header.authorization),i=await x.findOne({_id:a._id});let s="";if(t.username!==i.username&&!t.pic){const o=await x.findOne({username:a.username});if(o&&o.password)return void(e.body={code:501,msg:"用户名已存在/邮箱已被注册"});const n=_()();Object(c.b)(n,z.a.sign({_id:a._id},O.a.JWT_SERCET,{expiresIn:"30m"}));await U({type:"email",data:{key:n,username:t.username},code:"",expire:f()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:i.username,user:i.name});s="基本信息已修改成功,用户名修改请到发送的邮件修改"}["username","password","mobile"].map(e=>{delete t[e]});const o=await x.updateOne({_id:a._id},t);1===o.n&&1===o.ok?e.body={code:200,msg:""===s?"更新成功":s}:e.body={code:500,msg:更新失败}}async updateUsername(e){const t=e.query;if(t.key){const a=await Object(c.a)(t.key),i=Object(D.b)("Bearer "+a);await x.updateOne({_id:i._id},{username:t.username}),e.body={code:200,msg:"更新用户名成功!"}}}async updateUserpass(e){const t=e.query;if(t.key){const a=await Object(c.a)(t.key),i=Object(D.b)("Bearer "+a),s=await R.a.hash(t.password,5);await x.updateOne({_id:i._id},{password:s}),e.body={code:200,msg:"更新密码成功!"}}}async changepw(e){const{body:t}=e.request,a=await Object(D.b)(e.header.authorization),i=await x.findOne({_id:a._id});if(await R.a.compare(t.oldpwd,i.password)){const i=await R.a.hash(t.password,5);await x.updateOne({_id:a._id},{$set:{password:i}}),e.body={code:200,msg:"更改密码成功!"}}else e.body={code:500,msg:"您输入的原密码不正确!"}}async collect(e){}async setCollect(e){const t=e.query,a=await Object(D.b)(e.header.authorization);if(parseInt(t.isCollect))await q.deleteOne({uid:a._id,tid:t.tid}),e.body={code:200,msg:"取消收藏成功"};else{const i=new q({uid:a._id,tid:t.tid,title:t.title});(await i.save()).uid?e.body={code:200,msg:"收藏成功"}:e.body={code:400,msg:"收藏失败"}}}async getmsg(e){const t=e.query,a=t.page?t.page:0,i=await Object(D.b)(e.header.authorization),s=await L.a.getMsgList(i._id,a,6);e.body={code:200,data:s}}};const J=new(0,p.a.Schema)({uid:{type:String},cid:{type:String},created:{type:Date}});J.pre("save",(function(e){this.created=f()().format("YYYY-MM-DD HH:mm:ss"),e()})),J.post("save",(function(e,t,a){"MongoError"===e.name&&11e3===e.code?a(new Error("There was a duplicate key error")):a(e)})),J.statics={findByCid:function(e){return this.find({cid:e})}};var W=p.a.model("Comments_Hands",J);var A=new class{async getComments(e){const t=e.query,a=t.tid,i=t.page?t.page:0;let s=await L.a.getCommentsList(a,i,10);const o=await L.a.queryCont(a);let n={};if(void 0!==e.header.authorization&&(n=await Object(D.b)(e.header.authorization)),void 0!==n){s=s.map(e=>e.toJSON());for(let e=0;e<s.length;e++){let t=s[e];t.handed="0";const a=await W.findOne({cid:t._id,uid:n._id});a&&a.cid&&a.uid===n._id&&(t.handed="1")}}1===(await b.updateOne({_id:t.tid},{$inc:{reads:1}})).ok?e.body={code:200,total:o,data:s,msg:"查询成功"}:e.body={code:500,msg:"查询失败"}}async addComment(e){if(await(async e=>{let t=!0;const a=await Object(D.b)(e.header.authorization);if(void 0===a._id)return t;return"0"===(await x.findByID(a._id)).status&&(t=!1),t})(e))return void(e.body={code:500,msg:"用户已被禁言!"});const{body:t}=e.request,a=new L.a(t),i=await Object(D.b)(e.header.authorization);a.cuid=i._id;const s=await b.findOne({_id:t.tid});a.uid=s.uid;const o=await a.save(),n=await L.a.getTotal(s.uid);global.ws.send(s.uid,JSON.stringify({event:"message",msg:n}));1===(await b.updateOne({_id:t.tid},{$inc:{answer:1}})).ok?e.body={code:200,data:o,msg:"评论成功"}:e.body={code:500,data:o,msg:"评论失败"}}async setBest(e){const t=await Object(D.b)(e.header.authorization);if(void 0===t&&""!==t._id)return void(e.body={code:401,msg:"用户未登录,或者未授权"});const a=e.query,i=await b.findOne({_id:a.tid}),s=await L.a.findByCid(a.cid);if(s.cuid!==t._id)if(i.uid===t._id&&"0"===i.isEnd){const t=await b.updateOne({_id:a.tid},{$set:{isEnd:"1"}}),o=await L.a.updateOne({_id:a.cid},{$set:{isBest:"1"}});if(1===t.ok&&1===o.ok){1===(await x.updateOne({_id:s.cuid},{$inc:{favs:parseInt(i.fav)}})).ok?e.body={code:200,msg:"设置成功"}:e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"设置失败"}}else e.body={code:500,msg:"帖子已结贴或重复设置"};else e.body={code:500,msg:"不能给自己的评论设置最佳"}}async setHands(e){const t=await Object(D.b)(e.header.authorization),a=e.query;if((await W.find({cid:a.cid,uid:t._id})).length>0)return void(e.body={code:500,msg:"重复点赞"});const i=new W({cid:a.cid,uid:t._id});await i.save();1===(await L.a.updateOne({_id:a.cid},{$inc:{hands:1}})).ok?e.body={code:200,msg:"点赞成功"}:e.body={code:500,msg:"点赞失败"}}};const F=new n.a;F.prefix("/public"),F.get("/list",M.getPostList),F.get("/getCaptcha",u.getCaptcha),F.get("/tips",M.getTips),F.get("/links",M.getLinks),F.get("/topWeek",M.getTopWeek),F.get("/setEmail",N.updateUsername),F.get("/setPass",N.updateUserpass),F.get("/content/detail",M.getPostDetail),F.get("/comments",A.getComments);var V=F;var K=new class{async forget(e){const{body:t}=e.request,a=t.sid,i=t.code,s=await Object(D.a)(a,i),o=await x.findOne({username:t.username});if(s)if(o){const a=_()();Object(c.b)(a,z.a.sign({_id:o._id},O.a.JWT_SERCET,{expiresIn:"30m"}));await U({type:"forget",code:"",data:{key:a,username:t.username},expire:f()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:o.name});e.body={code:200,msg:"邮件发送成功,请查收更改密码"}}else e.body={code:500,msg:"用户名不存在"};else e.body={code:401,msg:"图片验证码不正确或已失效"}}async login(e){const{body:t}=e.request;let a=t.sid,i=t.code;if(await Object(D.a)(a,i)){let a=!1,i=await x.findOne({username:t.username});if(R.a.compare(t.password,i.password)&&(a=!0),a){const t=i.toJSON();["password","username","roles"].map(e=>{delete t[e]});const a=z.a.sign({_id:t._id},O.a.JWT_SERCET,{expiresIn:"7d"}),s=await E.findByUid(t._id);null!==s&&f()(s.created).format("YYYY-MM-DD")===f()().format("YYYY-MM-DD")?t.isSign=!0:t.isSign=!1,e.body={code:200,token:a,data:t}}else e.body={code:404,msg:"用户名/密码验证失败"}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async reg(e){let{body:t}=e.request,a=t.sid,i=t.code,s={},o=!0;if(await Object(D.a)(a,i)){let a=await x.findOne({username:t.username});null!==a&&void 0!==a.username&&(s.username=["此邮箱已被注册,可以通过忘记密码找回"],o=!1);let i=await x.findOne({name:t.name});if(null!==i&&void 0!==i.name&&(s.name=["此昵称已被注册"],o=!1),o){t.password=await R.a.hash(t.password,5);let a=new x({username:t.username,name:t.name,password:t.password,created:f()().format("YYYY-MM-DD HH:mm:ss")}),i=await a.save();return void(e.body={code:200,data:i,msg:"注册成功"})}}else s.code=["图片验证码不正确或已失效"];e.body={code:500,msg:s}}};const Q=new n.a;Q.prefix("/login"),Q.post("/forget",K.forget),Q.post("/login",K.login),Q.post("/reg",K.reg);var X=Q;const G=new n.a;G.prefix("/user"),G.get("/fav",N.userSign),G.post("/basic",N.updateUserInfo),G.post("/changepw",N.changepw),G.get("/Collect",N.collect),G.get("/setCollect",N.setCollect),G.get("/post",M.getPostListByUid),G.get("/deletePost",M.deletePostByTid),G.get("/getColleList",M.getColleByUid),G.get("/getmsg",N.getmsg);var Z=G;const ee=new n.a;ee.prefix("/content"),ee.post("/upload",M.uploadImg),ee.post("/add",M.addPost),ee.post("/uploadWang",M.uploadWangImg),ee.post("/editpost",M.editPost);var te=ee;const ae=new n.a;ae.prefix("/comments"),ae.post("/reply",A.addComment),ae.get("/accept",A.setBest),ae.get("/sethands",A.setHands);var ie=ae;t.a=s()(V,X,Z,te,ie)},function(e,t,a){"use strict";a.r(t),function(e){var t=a(16),i=a.n(t),s=a(17),o=a.n(s),n=a(13),d=a.n(n),r=a(18),c=a.n(r),u=a(19),p=a.n(u),l=a(32),f=a(25),m=a.n(f),g=a(26),y=a.n(g),b=a(27),h=a.n(b),w=a(28),v=a.n(w),_=a(29),O=a.n(_),Y=a(2),S=a(30),$=a(31);const x=new i.a,D=new $.a;D.init(),global.ws=D;const k=o()({secret:Y.a.JWT_SERCET}).unless({path:[/^\/public/,/\/login/]}),q=v()([m()({multipart:!0,formidable:{keepExtensions:!0,maxFieldsSize:5242880},onError:e=>{console.log(e)}}),p()(d.a.join(e,"../public")),h()(),y()({pretty:!1,param:"pretty"}),c()(),k,S.a]);x.use(O()()),x.use(q),x.use(Object(l.a)()),x.listen(3e3)}.call(this,"src")}]);