!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=23)}([function(e,t){e.exports=require("dayjs")},function(e,t,o){"use strict";t.a={DB_URL:"mongodb://user:password@127.0.0.1:27017/testdb",REDIS:{host:"127.0.0.1",port:6379,password:"123456"},JWT_SERCET:"F&l8mWkDt$9a1lQBuaej9oJ2T35@u7ur69szx6smKJINzMbUYjHxiFd*1KxpJ8zH"}},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-jwt")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("koa-helmet")},function(e,t){e.exports=require("koa-static")},function(e,t){e.exports=require("koa-combine-routers")},function(e,t){e.exports=require("svg-captcha")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("koa-body")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("@koa/cors")},function(e,t){e.exports=require("koa-compose")},function(e,t){e.exports=require("koa-compress")},function(e,t,o){"use strict";t.a=(e,t)=>t().catch(t=>{401==t.status?(e.status=401,e.body={code:401,msg:"Protected resource, use Authorization header to get"}):(e.status=t.status||500,e.body={code:500,msg:t.message})})},function(e,t,o){"use strict";var n=o(12),r=o.n(n),a=o(3),s=o.n(a),i=o(13),c=o.n(i),d=o(5),u=o.n(d),p=o(14),l=o(1);const f={host:l.a.REDIS.host,port:l.a.REDIS.port,detect_buffers:!0,retry_strategy:function(e){return e.error&&"ECONNREFUSED"===e.error.code?new Error("The server refused the connection"):e.total_retry_time>36e5?new Error("Retry time exhausted"):e.attempt>10?void 0:Math.min(100*e.attempt,3e3)}},g=Object(p.promisifyAll)(u.a.createClient(f));g.on("error",e=>{console.log("Redis Client Error:"+e)});var m=new class{constructor(){}async getCaptcha(e){const t=e.request.query;console.log(t.sid);const o=c.a.create({size:4,ignoreChars:"0o1il",color:!0,noise:Math.floor(5*Math.random()),width:150});var n,r,a;n=t.sid,r=o.text,a=600,void 0!==r&&null!=r&&""!==r&&("string"==typeof r?void 0!==a?g.set(n,r,"EX",a):g.set(n,r):"object"==typeof r&&Object.keys(r).forEach(e=>{g.hset(n,e,r[e],u.a.print)})),e.body={code:200,data:o.data}}},y=o(2),v=o.n(y);v.a.set("useCreateIndex",!0),v.a.connect(l.a.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),v.a.connection.on("connected",()=>{console.log("Mongoose connection open to "+l.a.DB_URL)}),v.a.connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),v.a.connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")});var b=v.a,w=o(0),h=o.n(w);const x=new(0,b.Schema)({title:{type:String,default:""},link:{type:String,default:""},type:{type:String,default:"link"},created:{type:Date},isTop:{type:String,default:""},sort:{type:String,default:""}});x.pre("save",(function(e){this.created=h()(),e()}));var S=b.model("links",x);const Y=new(0,b.Schema)({uid:{type:String,ref:"users"},catalog:{type:String},title:{type:String},content:{type:String},created:{type:Date},fav:{type:String},isEnd:{type:String},reads:{type:Number},answer:{type:Number},status:{type:String},isTop:{type:String},sort:{type:String},tags:{type:Array}});Y.pre("save",(function(e){this.created=h()().format("YYYY-MM-DD HH:mm:ss"),e()})),Y.statics={getList:function(e,t,o,n){return this.find(e).sort({[t]:-1}).skip(o*n).limit(n).populate({path:"uid",select:"name isVip pic"})},getTopWeek:function(){return this.find({created:{$gte:h()().subtract(7,"days")}},{answer:1,title:1}).sort({answer:-1}).limit(15)}};var D=b.model("post",Y);var M=new class{async getPostList(e){const t=e.query,o=t.sort?t.sort:"created",n=t.page?parseInt(t.page):0,r=t.limit?parseInt(t.limit):20,a={};void 0!==t.catalog&&""!==t.catalog&&(a.catalog=t.catalog),void 0!==t.isTop&&(a.isTop=t.isTop),void 0!==t.status&&""!==t.status&&(a.status=t.status),void 0!==t.tag&&""!==t.tag&&(a.tags={$elemMatch:{name:t.tag}});const s=await D.getList(a,o,n,r);e.body={code:200,data:s,msg:"获取文章列表成功"}}async getLinks(e){const t=await S.find({type:"links"});e.body={code:200,data:t}}async getTips(e){const t=await S.find({type:"tips"});e.body={code:200,data:t}}async getTopWeek(e){const t=await D.getTopWeek();e.body={code:200,data:t}}};const k=new s.a;k.prefix("/public"),k.get("/list",M.getPostList),k.get("/getCaptcha",m.getCaptcha),k.get("/tips",M.getTips),k.get("/links",M.getLinks),k.get("/topWeek",M.getTopWeek);var q=k,_=o(15),T=o.n(_);var E=async function(e){let t=T.a.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"imoocbrian@qq.com",pass:"rbkcbxwrurygjfca"}});return(await t.sendMail({from:'"认证邮件" <imoocbrian@qq.com>',to:e.email,subject:""!==e.user?`你好开发者，${e.user}！《慕课网前端全栈实践》注册码`:"《慕课网前端全栈实践》注册码",text:`您在《慕课网前端全栈实践》课程中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Imooc社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user}童鞋，重置链接有效时间30分钟，请在${e.expire}之前重置您的密码：</div>\n          <a href="http://www.imooc.com" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">立即重置密码</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `})).messageId},j=o(6),O=o.n(j),H=o(4),C=o.n(H);const $=async(e,t)=>{const o=await(e=>g.getAsync(e))(e);return null!=o&&o.toLowerCase()==t.toLowerCase()},R=new(0,b.Schema)({username:{type:String,index:{unique:!0},sparse:!0},password:{type:String},name:{type:String},created:{type:Date},updated:{type:Date},favs:{type:Number,default:0},gender:{type:String},roles:{type:Array,default:["user"]},pic:{type:String,default:"/img/touxiang.jpeg"},mobile:{type:String,match:/^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d{8}$/},status:{type:String,default:"0"},regmark:{type:String,default:""},location:{type:String,default:""},isVip:{type:String,default:"0"},count:{type:Number,default:"0"}});R.pre("save",(function(e){this.created=h()().format("YYYY-MM-DD HH:mm:ss"),e()})),R.pre("update",(function(e){this.update=h()().format("YYYY-MM-DD HH:mm:ss"),e()})),R.post("save",(function(e,t,o){"MongoError"===e.name&&11e3===e.code?o(new Error("Error: Monngoose has a duplicate key.")):o(e)})),R.statics={findByID:function(e){return this.findOne({_id:e},{password:0,username:0,mobile:0})}};var I=b.model("users",R);var L=new class{constructor(){}async forget(e){const{body:t}=e.request;try{let o=await E({code:"1234",expire:h()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:"Brian"});e.body={code:200,data:o,msg:"邮件发送成功"}}catch(e){console.log(e)}}async login(e){const{body:t}=e.request;let o=t.sid,n=t.code;if(await $(o,n)){let o=!1,n=await I.findOne({username:t.username});if(O.a.compare(t.password,n.password)&&(o=!0),o){const t=n.toJSON();["password","username","roles"].map(e=>{delete t[e]});let o=C.a.sign({_id:t._id},l.a.JWT_SERCET,{expiresIn:"1d"});e.body={code:200,token:o,data:t}}else e.body={code:404,msg:"用户名/密码验证失败"}}else e.body={code:401,msg:"图片验证码不正确或已失效"}}async reg(e){let{body:t}=e.request,o=t.sid,n=t.code,r={},a=!0;if(await $(o,n)){let o=await I.findOne({username:t.username});null!==o&&void 0!==o.username&&(r.username=["此邮箱已被注册,可以通过忘记密码找回"],a=!1);let n=await I.findOne({name:t.name});if(null!==n&&void 0!==n.name&&(r.name=["此昵称已被注册"],a=!1),a){t.password=await O.a.hash(t.password,5);let o=new I({username:t.username,name:t.name,password:t.password,created:h()().format("YYYY-MM-DD HH:mm:ss")}),n=await o.save();return void(e.body={code:200,data:n,msg:"注册成功"})}}else r.code=["图片验证码不正确或已失效"];e.body={code:500,msg:r}}};const N=new s.a;N.prefix("/login"),N.post("/forget",L.forget),N.post("/login",L.login),N.post("/reg",L.reg);var W=N;const B=new(0,b.Schema)({uid:{type:String,ref:"users"},created:{type:Date},favs:{type:Number},lastSign:{type:Date}});B.pre("save",(function(e){this.created=h()().format("YYYY-MM-DD HH:mm:ss"),e()})),B.statics={findByUid:function(e){return this.findOne({uid:e}).sort({created:-1})}};var P=b.model("sign_record",B);var U=new class{async userSign(e){const t=await(o=e.header.authorization,C.a.verify(o.split(" ")[1],l.a.JWT_SERCET));var o;const n=await P.findByUid(t._id),r=await I.findByID(t._id);let a={},s="";if(null!==n){if(h()(n.created).format("YYYY-MM-DD")===h()().format("YYYY-MM-DD"))return void(e.body={code:500,msg:"已签到",favs:r.favs,count:r.count});{let e=r.count,o=0;h()(n.lastSign).format("YYYY-MM-DD")===h()().subtract(1,"days").format("YYYY-MM-DD")?(e+=1,o=e<=10?5:e>10&&e<=20?10:e>20&&e<=40?15:20,await I.updateOne({_id:t._id},{$inc:{count:1,favs:o}}),s={favs:r.favs+o,count:r.count+1}):(await I.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),s={favs:r.favs+o,count:1},o=5),a=new P({uid:t._id,favs:o,lastSign:n.created}),await a.save()}}else await I.updateOne({_id:t._id},{$set:{count:1},$inc:{favs:5}}),a=new P({uid:t._id,favs:5,lastSign:h()().format("YYYY-MM-DD HH:mm:ss")}),await a.save(),s={favs:r.favs+5,count:1};e.body={code:200,msg:"cg",...s}}};const J=new s.a;J.prefix("/user"),J.get("/fav",U.userSign);var z=J;t.a=r()(q,W,z)},function(e,t,o){"use strict";o.r(t),function(e){var t=o(7),n=o.n(t),r=o(8),a=o.n(r),s=o(9),i=o.n(s),c=o(10),d=o.n(c),u=o(11),p=o.n(u),l=o(22),f=o(16),g=o.n(f),m=o(17),y=o.n(m),v=o(18),b=o.n(v),w=o(19),h=o.n(w),x=(o(20),o(1)),S=o(21);const Y=new n.a,D=a()({secret:x.a.JWT_SERCET}).unless({path:[/^\/public/,/\/login/]}),M=h()([g()(),p()(i.a.join(e,"../public")),b()(),y()({pretty:!1,param:"pretty"}),d()(),D,S.a]);Y.use(M),Y.use(Object(l.a)()),Y.listen(3e3)}.call(this,"src")}]);